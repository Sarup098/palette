<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Artevia Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Replaced jsPDF with the more efficient html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom Brand Color */
        .bg-brand { background-color: #a43c1a; }
        .text-brand { color: #a43c1a; }
        .border-brand { border-color: #a43c1a; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white shadow-lg rounded-lg printable-menu">
        <!-- Header -->
        <header id="menu-header" class="text-center p-8 bg-brand rounded-t-lg">
            <img src="https://raw.githubusercontent.com/Sarup098/artevia/main/Artevia_Palette_Logo.png" alt="Artevia Palette Logo" class="h-32 w-auto mx-auto">
        </header>
        
        <!-- Menu Content: Will be populated by JavaScript -->
        <div id="menu-content" class="p-8 bg-white">
            <p id="loading-message" class="text-center text-gray-500">Loading menu from the database...</p>
        </div>

        <!-- Footer with Print Button -->
        <footer id="print-button-container" class="p-4 text-center border-t non-printable">
            <button id="generate-image-btn" class="bg-brand text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition disabled:bg-gray-400 disabled:cursor-wait" disabled>
                Loading Menu...
            </button>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.firebasestorage.app",
            messagingSenderId: "424044050877",
            appId: "1:424044050877:web:9ea875314de19b70173ad4",
            measurementId: "G-XNVCLD42Y4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function preloadImages(imageElements) {
            const promises = Array.from(imageElements).map(img => {
                return new Promise((resolve) => {
                    if (img.complete) {
                        resolve(img);
                    } else {
                        img.onload = () => resolve(img);
                        img.onerror = () => resolve(img);
                    }
                });
            });
            await Promise.all(promises);
        }

        async function fetchAndRenderMenu() {
            const menuContent = document.getElementById('menu-content');
            const loadingMessage = document.getElementById('loading-message');
            const generateButton = document.getElementById('generate-image-btn');
            
            try {
                const q = query(collection(db, "menu"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    loadingMessage.textContent = 'No menu items found.';
                    generateButton.textContent = 'No Menu Found';
                    return;
                }
                
                const allItems = [];
                querySnapshot.forEach((doc) => allItems.push({id: doc.id, ...doc.data()}));

                const menuByCategory = allItems.reduce((acc, item) => {
                    const category = item.category || 'Uncategorized';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});

                const sortedCategories = Object.keys(menuByCategory).sort();
                
                menuContent.innerHTML = ''; 

                for (const category of sortedCategories) {
                    const section = document.createElement('section');
                    section.className = 'mb-12 menu-category';
                    
                    const sortedItems = menuByCategory[category].sort((a, b) => a.name.localeCompare(b.name));

                    let cardsHtml = '';
                    sortedItems.forEach(item => {
                        const placeholderText = encodeURIComponent(item.name);
                        cardsHtml += `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden flex menu-item-card border">
                                <img id="img-${item.id}" src="${item.imageUrl || `https://placehold.co/400x400/a43c1a/ffffff?text=${placeholderText}`}" 
                                     alt="${item.name}" 
                                     onerror="this.onerror=null; this.src='https://placehold.co/400x400/a43c1a/ffffff?text=${placeholderText}';"
                                     class="h-28 w-28 object-cover aspect-square flex-shrink-0">
                                <div class="p-4 flex flex-col flex-grow">
                                    <h3 class="font-bold text-lg">${item.name}</h3>
                                    <p class="text-sm text-gray-600 mt-1 flex-grow">${item.description || ''}</p>
                                    <p class="font-bold text-lg text-right text-brand mt-2">â‚¹${item.price}</p>
                                </div>
                            </div>
                        `;
                    });

                    section.innerHTML = `
                        <h2 class="text-3xl font-bold text-brand border-b-2 border-brand pb-2 mb-6">${category}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${cardsHtml}
                        </div>
                    `;
                    menuContent.appendChild(section);
                }
                
                const images = menuContent.querySelectorAll('img');
                generateButton.textContent = 'Loading Images...';
                await preloadImages(images);
                generateButton.disabled = false;
                generateButton.textContent = 'Download Menu as Image';

            } catch (error) {
                console.error("Error fetching menu:", error);
                loadingMessage.textContent = 'Failed to load menu.';
                loadingMessage.classList.add('text-red-500');
                generateButton.textContent = 'Error';
            }
        }
        
        // --- NEW: Image Generation Logic ---
        async function generateMenuImage() {
            const printButton = document.getElementById('generate-image-btn');
            const menuContainer = document.querySelector('.printable-menu'); // The main container
            
            printButton.disabled = true;
            printButton.textContent = 'Generating Image...';
            
            try {
                const canvas = await html2canvas(menuContainer, {
                    // Options to improve quality
                    scale: 2,
                    useCORS: true // Important for loading images from other domains
                });
                
                const link = document.createElement('a');
                link.download = 'Artevia-Palette-Menu.png';
                link.href = canvas.toDataURL("image/png");
                link.click();

            } catch (error) {
                console.error("Failed to generate image:", error);
                alert("Sorry, there was an error generating the menu image.");
            } finally {
                printButton.disabled = false;
                printButton.textContent = 'Download Menu as Image';
            }
        }

        signInAnonymously(auth)
            .then(() => {
                fetchAndRenderMenu();
            })
            .catch(error => {
                console.error("Authentication failed:", error);
                document.getElementById('loading-message').textContent = 'Error connecting to the server.';
            });

        document.getElementById('generate-image-btn').addEventListener('click', generateMenuImage);
    </script>

</body>
</html>

