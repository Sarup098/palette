<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Artevia Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom Brand Color */
        .bg-brand { background-color: #a43c1a; }
        .hover\:bg-brand-dark:hover { background-color: #8a3216; }
        .text-brand { color: #a43c1a; }

        .kanban-column {
            scroll-snap-align: start;
        }
        .kanban-container {
            scroll-snap-type: x mandatory;
        }
        .animate-flash-red {
            animation: flash-red 1s infinite;
        }
        @keyframes flash-red {
            0%, 100% { border-color: #ef4444; }
            50% { border-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Header -->
    <header class="bg-brand shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 py-3 flex items-center gap-4">
             <img src="https://raw.githubusercontent.com/Sarup098/artevia/main/Artevia_Palette_Logo.png" alt="Artevia Palette Logo" class="h-12 w-auto">
            <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">

        <!-- Daily Summary -->
        <section id="daily-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Orders</p><p id="total-orders" class="text-2xl font-bold">0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">₹0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Paid</p><p id="total-paid" class="text-2xl font-bold text-green-600">₹0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Unpaid</p><p id="total-unpaid" class="text-2xl font-bold text-red-600">₹0</p></div>
        </section>
        
        <!-- Table Management -->
        <section class="mb-8">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Table Management</h2>
                <button id="manage-stock-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">Manage Stock</button>
            </div>
            <div id="admin-table-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                <!-- Admin table view will be injected here -->
            </div>
        </section>


        <!-- Order Tracker -->
        <section>
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Live Order Tracker</h2>
                <div class="flex items-center gap-2">
                     <button id="view-log-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md text-sm hover:bg-gray-700">Today's Full Log</button>
                    <button id="archive-btn" class="bg-brand text-white px-4 py-2 rounded-md text-sm hover:bg-brand-dark">Archive Paid Orders</button>
                    <button id="download-pdf-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700">Download Report</button>
                </div>
            </div>
            <div class="kanban-container flex overflow-x-auto gap-4 pb-4">
                <!-- Kanban Columns -->
                <div id="col-Pending" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-red-600">Pending</h3><div class="order-list space-y-3"></div></div>
                <div id="col-InProgress" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-yellow-600">In Progress</h3><div class="order-list space-y-3"></div></div>
                <div id="col-Ready" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-blue-600">Ready</h3><div class="order-list space-y-3"></div></div>
                <div id="col-OutforDelivery" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-purple-600">Out for Delivery</h3><div class="order-list space-y-3"></div></div>
                <div id="col-Completed" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-green-600">Completed</h3><div class="order-list space-y-3"></div></div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    
    <!-- Table Management Modal -->
    <div id="table-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-md hidden p-6">
        <!-- Content injected by JS -->
    </div>

    <!-- Stock Management Modal -->
    <div id="stock-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-lg hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
             <h3 class="text-xl font-bold">Menu Stock Status</h3>
            <button id="close-stock-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="p-4 max-h-[70vh] overflow-y-auto">
             <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                    <tr>
                        <th scope="col" class="px-2 py-3">Item</th>
                        <th scope="col" class="px-2 py-3 text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="stock-status-table-body">
                    <!-- Rows will be injected by JS -->
                </tbody>
            </table>
        </div>
    </div>
    
     <!-- Full Log Modal -->
    <div id="log-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-2xl hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
             <h3 class="text-xl font-bold">Today's Full Order Log</h3>
            <button id="close-log-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div id="log-content" class="p-4 max-h-[70vh] overflow-y-auto">
            <!-- Log content injected here -->
        </div>
    </div>

    <!-- REFINED: Add Items to Order Modal -->
    <div id="add-items-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-4xl hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
             <h3 id="add-items-modal-title" class="text-xl font-bold">Add Items to Order</h3>
            <button id="close-add-items-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2" style="max-height: 70vh;">
            <!-- Left Panel: Menu with Search/Filter -->
            <div class="p-4 border-r flex flex-col">
                <div class="sticky top-0 bg-white pb-2">
                    <h4 class="font-bold mb-2">Available Menu</h4>
                    <input type="text" id="add-item-search" placeholder="Search for an item..." class="w-full p-2 border rounded-md mb-2">
                    <select id="add-item-category-filter" class="w-full p-2 border rounded-md"></select>
                </div>
                <div id="add-items-menu-list" class="space-y-2 flex-grow overflow-y-auto">
                    <!-- Filtered menu items will appear here -->
                </div>
            </div>
            <!-- Right Panel: Current Bill -->
            <div class="p-4 bg-gray-50 flex flex-col">
                <h4 class="font-bold mb-2 sticky top-0 bg-gray-50 pb-2">Current Bill</h4>
                <div id="add-items-current-order" class="space-y-2 flex-grow overflow-y-auto"></div>
                <div class="mt-4 pt-4 border-t font-bold text-xl flex justify-between flex-shrink-0">
                    <span>New Total:</span>
                    <span id="add-items-new-total">₹0</span>
                </div>
            </div>
        </div>
        <div class="p-4 border-t bg-gray-50">
            <button id="save-added-items-btn" class="w-full bg-brand text-white font-bold py-3 px-4 rounded-md hover:bg-brand-dark">Save Changes to Order</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, writeBatch, query, where, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.firebasestorage.app",
            messagingSenderId: "424044050877",
            appId: "1:424044050877:web:9ea875314de19b70173ad4",
            measurementId: "G-XNVCLD42Y4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allTodayOrders = [];
        let menuItemsCache = [];
        const ORDER_STATUSES = ['Pending', 'In Progress', 'Ready', 'Out for Delivery', 'Completed'];

        // Modal Elements
        const modalBackdrop = document.getElementById('modal-backdrop');
        const tableModal = document.getElementById('table-modal');
        const stockModal = document.getElementById('stock-modal');
        const addItemsModal = document.getElementById('add-items-modal');
        const logModal = document.getElementById('log-modal');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeAdminPanel();
            }
        });

        signInAnonymously(auth).catch(error => {
            console.error("Anonymous sign-in failed:", error);
            alert("Could not connect to the server.");
        });

        function initializeAdminPanel() {
            listenForTables();
            listenForOrders();
            listenForMenuStock();
            attachStaticEventListeners();
        }

        function listenForTables() {
            onSnapshot(collection(db, 'tables'), (snapshot) => {
                const tableGrid = document.getElementById('admin-table-grid');
                tableGrid.innerHTML = '';
                const tables = [];
                
                const batch = writeBatch(db);
                let changesMade = false;

                snapshot.forEach(doc => {
                    let table = {id: doc.id, ...doc.data()};
                    if (table.status === 'Cleaning' && table.cleaningUntil && table.cleaningUntil.toDate() <= new Date()) {
                        batch.update(doc.ref, { status: 'Available', cleaningUntil: null });
                        changesMade = true;
                        table.status = 'Available'; 
                    }
                    tables.push(table);
                });

                if (changesMade) {
                    batch.commit().catch(err => console.error("Error auto-updating table status:", err));
                }
                
                tables.sort((a, b) => {
                    const numA = (a.tableNumber && typeof a.tableNumber === 'string') ? parseInt(a.tableNumber.slice(1)) : 0;
                    const numB = (b.tableNumber && typeof b.tableNumber === 'string') ? parseInt(b.tableNumber.slice(1)) : 0;
                    return numA - numB;
                });

                tables.forEach(table => {
                    const tableEl = document.createElement('button');
                    tableEl.dataset.tableId = table.id;
                    let bgColor = 'bg-gray-200';
                    let statusText = table.status;
                    
                    if (table.needsWater || table.needsHelp || table.needsBill) {
                        tableEl.classList.add('animate-flash-red', 'border-2');
                    }

                    switch(table.status) {
                        case 'Available': bgColor = 'bg-green-200'; break;
                        case 'Occupied': bgColor = 'bg-yellow-200'; break;
                        case 'Cleaning': bgColor = 'bg-blue-200'; break;
                        case 'Blocked': bgColor = 'bg-red-200'; break;
                    }

                    let alertsAndTimersHtml = '';
                    if (table.status === 'Occupied' && table.availableTime) {
                        const freeIn = Math.round((table.availableTime.toDate() - new Date()) / 60000);
                        if (freeIn > 0) alertsAndTimersHtml += `<div class="text-xs text-blue-700 font-semibold mt-1">~${freeIn} min left</div>`;
                    }
                    if (table.status === 'Cleaning' && table.cleaningUntil) {
                        const cleanIn = Math.round((table.cleaningUntil.toDate() - new Date()) / 1000);
                        if (cleanIn > 0) alertsAndTimersHtml += `<div class="text-xs font-semibold mt-1">${cleanIn}s left</div>`;
                    }
                    if (table.needsWater) alertsAndTimersHtml += `<div class="text-xs mt-1 font-bold bg-blue-500 text-white px-1 rounded-sm w-full">WATER</div>`;
                    if (table.needsHelp) alertsAndTimersHtml += `<div class="text-xs mt-1 font-bold bg-yellow-500 text-black px-1 rounded-sm w-full">HELP</div>`;
                    if (table.needsBill) alertsAndTimersHtml += `<div class="text-xs mt-1 font-bold bg-red-500 text-white px-1 rounded-sm w-full">BILL</div>`;
                    
                    tableEl.className = `p-2 rounded-lg text-center transition ${bgColor} flex flex-col justify-start min-h-[90px]`;
                    tableEl.innerHTML = `
                        <div class="font-bold">${table.tableNumber || 'N/A'} <span class="text-xs font-normal text-gray-700">(${table.capacity}p)</span></div>
                        <div class="text-sm">${statusText}</div>
                        <div class="flex-grow flex flex-col justify-end">
                            ${alertsAndTimersHtml}
                        </div>
                    `;
                    tableGrid.appendChild(tableEl);
                });
            });
        }
        
        function listenForOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startOfToday = Timestamp.fromDate(today);
            const q = query(collection(db, 'orders'), where('createdAt', '>=', startOfToday));
            
            onSnapshot(q, (snapshot) => {
                allTodayOrders = [];
                const activeOrders = [];
                let totalOrders = 0, totalRevenue = 0, totalPaid = 0, totalUnpaid = 0;

                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    allTodayOrders.push(order);
                    totalOrders++;
                    totalRevenue += order.totalAmount;
                    if (order.paymentStatus === 'Paid') totalPaid += order.totalAmount;
                    else totalUnpaid += order.totalAmount;
                    if (!order.isHidden) activeOrders.push(order);
                });
                
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-revenue').textContent = `₹${totalRevenue.toFixed(0)}`;
                document.getElementById('total-paid').textContent = `₹${totalPaid.toFixed(0)}`;
                document.getElementById('total-unpaid').textContent = `₹${totalUnpaid.toFixed(0)}`;
                
                renderKanban(activeOrders);
            });
        }

        function listenForMenuStock() {
            onSnapshot(collection(db, 'menu'), (snapshot) => {
                const tableBody = document.getElementById('stock-status-table-body');
                menuItemsCache = [];
                snapshot.forEach(doc => menuItemsCache.push({ id: doc.id, ...doc.data() }));
                
                menuItemsCache.sort((a,b) => a.name.localeCompare(b.name));
                
                tableBody.innerHTML = menuItemsCache.map(item => {
                    const currentStatus = item.stockStatus || 'in_stock';
                    const statusButtons = `
                        <div class="flex justify-center gap-1 text-xs font-semibold">
                            <button data-id="${item.id}" data-status="in_stock" class="stock-status-btn px-2 py-1 rounded-md ${currentStatus === 'in_stock' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-800'}">AVL</button>
                            <button data-id="${item.id}" data-status="few_left" class="stock-status-btn px-2 py-1 rounded-md ${currentStatus === 'few_left' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-800'}">FEW</button>
                            <button data-id="${item.id}" data-status="sold_out" class="stock-status-btn px-2 py-1 rounded-md ${currentStatus === 'sold_out' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-800'}">NOT AVL</button>
                        </div>
                    `;
                    return `<tr class="bg-white border-b">
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${item.name}</td>
                        <td class="px-2 py-2">${statusButtons}</td>
                    </tr>`;
                }).join('');
            });
        }
        
        function renderKanban(orders) {
            ORDER_STATUSES.forEach(status => {
                const colId = `col-${status.replace(/ /g, '')}`;
                const col = document.getElementById(colId);
                if(col) col.querySelector('.order-list').innerHTML = '';
            });
            
            orders.sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());

            orders.forEach(order => {
                const colId = `col-${order.status.replace(/ /g, '')}`;
                const col = document.getElementById(colId);
                if (!col) return;

                const card = document.createElement('div');
                card.className = 'p-3 bg-gray-50 rounded-md border border-gray-200';
                card.dataset.id = order.id;

                const paymentClass = order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600';
                const paymentBg = order.paymentStatus === 'Paid' ? 'bg-green-100' : 'bg-red-100';

                card.innerHTML = `
                    <p class="font-bold">${order.customerName} (${order.whatsappNumber})</p>
                    <p class="text-sm text-gray-500">${order.orderType} ${order.tableId || ''}</p>
                    <p class="font-semibold my-1">₹${order.totalAmount.toFixed(0)}</p>
                    <div class="text-xs my-2">
                        ${Object.values(JSON.parse(order.items)).map(i => `${i.quantity}x ${i.name}`).join(', ')}
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <button class="payment-toggle-btn ${paymentBg} ${paymentClass} px-2 py-1 rounded-full font-semibold" data-id="${order.id}" data-current="${order.paymentStatus}">
                            ${order.paymentStatus}
                        </button>
                        <div class="flex items-center gap-1">
                            <button class="add-items-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" data-id="${order.id}">+ Add</button>
                            <button class="whatsapp-btn bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" data-id="${order.id}">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            </button>
                            ${renderNextStepButton(order)}
                        </div>
                    </div>
                `;
                col.querySelector('.order-list').appendChild(card);
            });
        }

        function renderNextStepButton(order) {
            const currentIdx = ORDER_STATUSES.indexOf(order.status);
            if (currentIdx < ORDER_STATUSES.length - 1) {
                const nextStatus = ORDER_STATUSES[currentIdx + 1];
                return `<button class="next-step-btn bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800" data-id="${order.id}" data-next-status="${nextStatus}">
                    &rarr; ${nextStatus}
                </button>`;
            }
            return '';
        }

        // --- ALL ASYNC ACTIONS ---
        async function updateStockStatus(itemId, newStatus) { await updateDoc(doc(db, 'menu', itemId), { stockStatus: newStatus }); }
        async function togglePaymentStatus(orderId, currentStatus) { const newStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid'; await updateDoc(doc(db, 'orders', orderId), { paymentStatus: newStatus }); }
        async function advanceOrderStatus(orderId, nextStatus) { await updateDoc(doc(db, 'orders', orderId), { status: nextStatus }); }
        async function setTableTime(mins) { const availableTime = new Date(Date.now() + mins * 60000); await updateDoc(doc(db, 'tables', currentTable.id), { availableTime: Timestamp.fromDate(availableTime) }); closeModals(); }
        async function resolveHelpRequest(type) { await updateDoc(doc(db, 'tables', currentTable.id), { [type]: false }); closeModals(); }

        // --- MODAL AND UI LOGIC ---
        let currentTable = null; 
        let currentOrderForAdding = null;
        let tempCartForAdding = {};

        async function openTableModal(tableId) {
            const tableSnap = await getDoc(doc(db, 'tables', tableId));
            if (!tableSnap.exists()) return;
            currentTable = { id: tableSnap.id, ...tableSnap.data() };

            let helpRequestsHtml = '';
            if (currentTable.needsWater) helpRequestsHtml += `<button data-type="needsWater" class="resolve-btn w-full text-left bg-yellow-100 text-yellow-800 p-2 rounded mb-2 hover:bg-yellow-200">Resolve Water Request</button>`;
            if (currentTable.needsHelp) helpRequestsHtml += `<button data-type="needsHelp" class="resolve-btn w-full text-left bg-yellow-100 text-yellow-800 p-2 rounded mb-2 hover:bg-yellow-200">Resolve Help Request</button>`;
            if (currentTable.needsBill) helpRequestsHtml += `<button data-type="needsBill" class="resolve-btn w-full text-left bg-yellow-100 text-yellow-800 p-2 rounded mb-2 hover:bg-yellow-200">Resolve Bill Request</button>`;
            
            tableModal.innerHTML = `<h3 class="text-2xl font-bold mb-4">Manage Table ${currentTable.tableNumber}</h3> ${helpRequestsHtml} <div class="mb-4"><p class="font-semibold mb-2">Change Status:</p><div class="grid grid-cols-2 gap-2">${['Available', 'Occupied', 'Blocked'].map(status => `<button data-status="${status}" class="status-change-btn p-2 rounded ${currentTable.status === status ? 'bg-brand text-white' : 'bg-gray-200'}">${status}</button>`).join('')}</div></div><div class="mb-4"><p class="font-semibold mb-2">Set estimated availability time:</p><div class="grid grid-cols-3 gap-2"><button data-mins="10" class="time-set-btn p-2 bg-gray-200 rounded">10 min</button><button data-mins="20" class="time-set-btn p-2 bg-gray-200 rounded">20 min</button><button data-mins="30" class="time-set-btn p-2 bg-gray-200 rounded">30 min</button></div></div><button id="close-table-modal" class="mt-4 w-full p-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>`;
            
            showModal(tableModal);
        }

        function openStockModal() { showModal(stockModal); }

        function openAddItemsModal(orderId) {
            currentOrderForAdding = allTodayOrders.find(o => o.id === orderId);
            if (!currentOrderForAdding) return;
            
            tempCartForAdding = JSON.parse(currentOrderForAdding.items);
            document.getElementById('add-items-modal-title').textContent = `Add Items for ${currentOrderForAdding.customerName}`;
            
            const categoryFilter = document.getElementById('add-item-category-filter');
            const categories = ['All', ...new Set(menuItemsCache.map(item => item.category))];
            categoryFilter.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');

            renderAddItemsMenuList();
            updateAddItemsBillUI();
            showModal(addItemsModal);
        }

        function renderAddItemsMenuList() {
            const menuList = document.getElementById('add-items-menu-list');
            const searchTerm = document.getElementById('add-item-search').value.toLowerCase();
            const selectedCategory = document.getElementById('add-item-category-filter').value;

            menuList.innerHTML = menuItemsCache
                .filter(item => {
                    const nameMatch = item.name.toLowerCase().includes(searchTerm);
                    const categoryMatch = selectedCategory === 'All' || item.category === selectedCategory;
                    return nameMatch && categoryMatch;
                })
                .map(item => {
                    const isSoldOut = item.stockStatus === 'sold_out';
                    const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                    return `
                    <div class="flex justify-between items-center p-2 border rounded-md ${isSoldOut ? 'opacity-50' : ''}">
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-xs text-gray-500">₹${finalPrice.toFixed(0)}</p>
                        </div>
                        <button data-id="${item.id}" class="add-item-to-cart-btn bg-green-500 text-white rounded-full h-7 w-7 flex items-center justify-center text-xl ${isSoldOut ? 'cursor-not-allowed' : ''}" ${isSoldOut ? 'disabled' : ''}>+</button>
                    </div>`;
                }).join('');
        }

        function updateAddItemsBillUI() {
            const currentOrderList = document.getElementById('add-items-current-order');
            const newTotalEl = document.getElementById('add-items-new-total');
            let newTotal = 0;

            currentOrderList.innerHTML = Object.entries(tempCartForAdding).map(([itemId, itemData]) => {
                const itemDetails = menuItemsCache.find(mi => mi.id === itemId);
                 if (!itemDetails) return '';
                const finalPrice = itemDetails.price - (itemDetails.price * (itemDetails.discount || 0) / 100);
                newTotal += finalPrice * itemData.quantity;
                return `
                <div class="flex justify-between items-center text-sm py-1">
                    <div>
                        <p class="font-semibold">${itemData.name}</p>
                        <p class="text-xs text-gray-600">${itemData.quantity} x ₹${finalPrice.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-id="${itemId}" data-action="decrease" class="cart-modify-btn bg-gray-200 rounded-full h-6 w-6 flex items-center justify-center">-</button>
                        <span class="font-bold w-4 text-center">${itemData.quantity}</span>
                        <button data-id="${itemId}" data-action="increase" class="cart-modify-btn bg-gray-200 rounded-full h-6 w-6 flex items-center justify-center">+</button>
                    </div>
                </div>`;
            }).join('') || '<p class="text-center text-gray-500 mt-4">No items in order yet.</p>';
            
            newTotalEl.textContent = `₹${newTotal.toFixed(2)}`;
        }

        async function saveAddedItems() {
            let newTotal = 0;
            const updatedItems = {};

            for (const itemId in tempCartForAdding) {
                const itemData = tempCartForAdding[itemId];
                const itemDetails = menuItemsCache.find(mi => mi.id === itemId);
                if (!itemDetails) continue; 
                
                const finalPrice = itemDetails.price - (itemDetails.price * (itemDetails.discount || 0) / 100);
                newTotal += finalPrice * itemData.quantity;
                updatedItems[itemId] = { 
                    name: itemDetails.name, 
                    quantity: itemData.quantity, 
                    price: finalPrice
                };
            }
            
            await updateDoc(doc(db, 'orders', currentOrderForAdding.id), {
                items: JSON.stringify(updatedItems),
                totalAmount: newTotal
            });

            closeModals();
        }
        
        async function changeTableStatus(newStatus) {
            const tableRef = doc(db, 'tables', currentTable.id);
            let updateData = { status: newStatus };
            
            if (currentTable.status === 'Occupied' && newStatus === 'Available') {
                updateData = { status: 'Cleaning', orderId: null, availableTime: null, needsWater: false, needsHelp: false, needsBill: false, cleaningUntil: Timestamp.fromDate(new Date(Date.now() + 2 * 60000)) };
            } else if (newStatus === 'Available') {
                 updateData = { status: 'Available', orderId: null, availableTime: null, needsWater: false, needsHelp: false, needsBill: false, cleaningUntil: null };
            }
            
            await updateDoc(tableRef, updateData);
            closeModals();
        }
        
        function closeModals() {
            document.body.style.overflow = 'auto';
            modalBackdrop.classList.add('hidden');
            [tableModal, stockModal, addItemsModal, logModal].forEach(m => m.classList.add('hidden'));
            currentTable = null;
            currentOrderForAdding = null;
            tempCartForAdding = {};
        }

        function showModal(modal) {
            document.body.style.overflow = 'hidden';
            modalBackdrop.classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        function sendWhatsAppBill(orderId) {
            const order = allTodayOrders.find(o => o.id === orderId);
            if (!order) { alert("Order not found!"); return; }

            let message = `Hello ${order.customerName},\n\nHere is your bill from Artevia Palette:\n\n`;
            message += "--------------------------------\n";
            Object.values(JSON.parse(order.items)).forEach(item => {
                const itemTotal = item.quantity * item.price;
                message += `${item.quantity} x ${item.name} - ₹${itemTotal.toFixed(2)}\n`;
            });
            message += "--------------------------------\n";
            message += `*Total Amount: ₹${order.totalAmount.toFixed(2)}*\n\n`;
            message += "Hope you enjoyed your meal! Please visit us again soon.\n";

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/91${order.whatsappNumber}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
        
        function attachStaticEventListeners() {
            document.querySelector('.kanban-container').addEventListener('click', (e) => {
                const paymentBtn = e.target.closest('.payment-toggle-btn');
                const nextStepBtn = e.target.closest('.next-step-btn');
                const whatsappBtn = e.target.closest('.whatsapp-btn');
                const addItemsBtn = e.target.closest('.add-items-btn');

                if (paymentBtn) togglePaymentStatus(paymentBtn.dataset.id, paymentBtn.dataset.current);
                if (nextStepBtn) advanceOrderStatus(nextStepBtn.dataset.id, nextStepBtn.dataset.nextStatus);
                if (whatsappBtn) sendWhatsAppBill(whatsappBtn.dataset.id);
                if (addItemsBtn) openAddItemsModal(addItemsBtn.dataset.id);
            });

            document.getElementById('admin-table-grid').addEventListener('click', (e) => {
                const tableButton = e.target.closest('button');
                if (tableButton && tableButton.dataset.tableId) openTableModal(tableButton.dataset.tableId);
            });

            tableModal.addEventListener('click', (e) => {
                const statusBtn = e.target.closest('.status-change-btn');
                const timeBtn = e.target.closest('.time-set-btn');
                const resolveBtn = e.target.closest('.resolve-btn');
                if (e.target.id === 'close-table-modal') closeModals();
                if (statusBtn) changeTableStatus(statusBtn.dataset.status);
                if (timeBtn) setTableTime(timeBtn.dataset.mins);
                if (resolveBtn) resolveHelpRequest(resolveBtn.dataset.type);
            });
            
            document.getElementById('stock-status-table-body').addEventListener('click', (e) => {
                const statusButton = e.target.closest('.stock-status-btn');
                if(statusButton) updateStockStatus(statusButton.dataset.id, statusButton.dataset.status);
            });

            addItemsModal.addEventListener('click', (e) => {
                const addItemBtn = e.target.closest('.add-item-to-cart-btn');
                const modifyBtn = e.target.closest('.cart-modify-btn');
                
                if (addItemBtn) {
                    const itemId = addItemBtn.dataset.id;
                    const item = menuItemsCache.find(i=>i.id===itemId);
                    if (!tempCartForAdding[itemId]) {
                        tempCartForAdding[itemId] = { quantity: 0, name: item.name };
                    }
                    tempCartForAdding[itemId].quantity++;
                    updateAddItemsBillUI();
                }

                if (modifyBtn) {
                    const itemId = modifyBtn.dataset.id;
                    const action = modifyBtn.dataset.action;
                    if (tempCartForAdding[itemId]) {
                        if (action === 'increase') tempCartForAdding[itemId].quantity++;
                        if (action === 'decrease') tempCartForAdding[itemId].quantity--;
                        if (tempCartForAdding[itemId].quantity <= 0) delete tempCartForAdding[itemId];
                        updateAddItemsBillUI();
                    }
                }
            });
            
            document.getElementById('add-item-search').addEventListener('input', renderAddItemsMenuList);
            document.getElementById('add-item-category-filter').addEventListener('change', renderAddItemsMenuList);

            document.getElementById('manage-stock-btn').onclick = openStockModal;
            document.getElementById('close-stock-modal').onclick = closeModals;
            document.getElementById('close-add-items-modal').onclick = closeModals;
            document.getElementById('save-added-items-btn').onclick = saveAddedItems;


            document.getElementById('archive-btn').onclick = async () => {
                const q = query(collection(db, 'orders'), where('status', '==', 'Completed'), where('paymentStatus', '==', 'Paid'));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(docSnap => batch.update(docSnap.ref, { isHidden: true }));
                await batch.commit();
                alert(`${snapshot.size} orders archived.`);
            };

            document.getElementById('download-pdf-btn').onclick = () => {
                const doc = new jsPDF();
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-IN');
                let y = 15;

                doc.setFontSize(20);
                doc.text("Artevia Palette - Daily Order Report", 105, y, { align: 'center' });
                y += 5;
                doc.setFontSize(12);
                doc.text(`Date: ${formattedDate}`, 105, y, { align: 'center' });
                y += 10;

                allTodayOrders.sort((a,b) => a.createdAt.toDate() - b.createdAt.toDate()).forEach(order => {
                    if (y > 270) {
                        doc.addPage();
                        y = 15;
                    }
                    const time = order.createdAt.toDate().toLocaleTimeString('en-IN');
                    const customerInfo = `${order.customerName} (${order.whatsappNumber})`;
                    const orderInfo = `${order.orderType} ${order.tableId || ''} - ${time}`;
                    const items = Object.values(JSON.parse(order.items)).map(i => `${i.quantity}x ${i.name} (₹${i.price.toFixed(2)})`).join(', ');
                    doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text(customerInfo, 14, y); y+= 6;
                    doc.setFontSize(10); doc.setFont(undefined, 'normal'); doc.text(orderInfo, 14, y); doc.text(`Total: ₹${order.totalAmount.toFixed(2)}`, 195, y, { align: 'right' }); y += 6;
                    doc.text(`Items: ${items}`, 14, y, { maxWidth: 180 }); y += 10;
                    doc.text(`Status: ${order.status} / ${order.paymentStatus}`, 14, y); y += 5;
                    doc.setLineWidth(0.2); doc.line(14, y, 195, y); y += 8;
                });
                doc.save(`daily_orders_${today.toISOString().split('T')[0]}.pdf`);
            };
            
            document.getElementById('view-log-btn').onclick = () => {
                 const logContent = document.getElementById('log-content');
                 logContent.innerHTML = '';
                 const groupedByCustomer = allTodayOrders.reduce((acc, order) => {
                    (acc[order.whatsappNumber] = acc[order.whatsappNumber] || []).push(order);
                    return acc;
                 }, {});
                 
                 for (const number in groupedByCustomer) {
                     const orders = groupedByCustomer[number].sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
                     const customerName = orders[0].customerName;
                     const customerDiv = document.createElement('div');
                     customerDiv.className = 'mb-6';
                     customerDiv.innerHTML = `<h4 class="font-bold text-lg mb-2">${customerName} - ${number}</h4>`;
                     orders.forEach(order => {
                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'p-3 bg-gray-50 rounded border mb-2';
                         orderDiv.innerHTML = `
                            <div class="flex justify-between items-center text-sm">
                                <span>${order.createdAt.toDate().toLocaleTimeString()} - ${order.orderType} ${order.tableId || ''}</span>
                                <span>Status: ${order.status} / ${order.paymentStatus}</span>
                                <span class="font-bold">₹${order.totalAmount.toFixed(0)}</span>
                            </div>
                         `;
                         customerDiv.appendChild(orderDiv);
                     });
                     logContent.appendChild(customerDiv);
                 }
                 showModal(document.getElementById('log-modal'));
            };

            document.getElementById('close-log-btn').onclick = closeModals;
            modalBackdrop.onclick = closeModals;
        }
    </script>
</body>
</html>

