<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Artevia Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom Brand Color */
        .bg-brand { background-color: #a43c1a; }
        .hover\:bg-brand-dark:hover { background-color: #8a3216; }
        .text-brand { color: #a43c1a; }

        .kanban-column {
            scroll-snap-align: start;
        }
        .kanban-container {
            scroll-snap-type: x mandatory;
        }
        .animate-flash-red {
            animation: flash-red 1s infinite;
        }
        @keyframes flash-red {
            0%, 100% { border-color: #ef4444; }
            50% { border-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Header -->
    <header class="bg-brand shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 py-3 flex items-center gap-4">
             <img src="https://raw.githubusercontent.com/Sarup098/artevia/main/Artevia_Palette_Logo.png" alt="Artevia Palette Logo" class="h-12 w-auto">
            <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">

        <!-- Daily Summary -->
        <section id="daily-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Orders</p><p id="total-orders" class="text-2xl font-bold">0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">₹0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Paid</p><p id="total-paid" class="text-2xl font-bold text-green-600">₹0</p></div>
            <div class="bg-white p-4 rounded-lg shadow text-center"><p class="text-sm text-gray-500">Total Unpaid</p><p id="total-unpaid" class="text-2xl font-bold text-red-600">₹0</p></div>
        </section>
        
        <!-- Table Management -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Table Management</h2>
            <div id="admin-table-grid" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">
                <!-- Admin table view will be injected here -->
            </div>
        </section>

        <!-- Order Tracker -->
        <section>
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Live Order Tracker</h2>
                <div class="flex items-center gap-2">
                     <button id="view-log-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md text-sm hover:bg-gray-700">Today's Full Log</button>
                    <button id="archive-btn" class="bg-brand text-white px-4 py-2 rounded-md text-sm hover:bg-brand-dark">Archive Paid Orders</button>
                    <button id="download-pdf-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700">Download Report</button>
                </div>
            </div>
            <div class="kanban-container flex overflow-x-auto gap-4 pb-4">
                <!-- Kanban Columns -->
                <div id="col-Pending" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-red-600">Pending</h3><div class="order-list space-y-3"></div></div>
                <div id="col-InProgress" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-yellow-600">In Progress</h3><div class="order-list space-y-3"></div></div>
                <div id="col-Ready" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-blue-600">Ready</h3><div class="order-list space-y-3"></div></div>
                <div id="col-OutforDelivery" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-purple-600">Out for Delivery</h3><div class="order-list space-y-3"></div></div>
                <div id="col-Completed" class="kanban-column bg-white rounded-lg shadow p-3 w-72 sm:w-80 flex-shrink-0"><h3 class="font-bold mb-3 text-green-600">Completed</h3><div class="order-list space-y-3"></div></div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    
    <!-- Table Management Modal -->
    <div id="table-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-md hidden p-6">
        <!-- Content injected by JS -->
    </div>
    
     <!-- Full Log Modal -->
    <div id="log-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-40 w-full max-w-2xl hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
             <h3 class="text-xl font-bold">Today's Full Order Log</h3>
            <button id="close-log-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div id="log-content" class="p-4 max-h-[70vh] overflow-y-auto">
            <!-- Log content injected here -->
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, writeBatch, query, where, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.firebasestorage.app",
            messagingSenderId: "424044050877",
            appId: "1:424044050877:web:9ea875314de19b70173ad4",
            measurementId: "G-XNVCLD42Y4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allTodayOrders = [];
        const ORDER_STATUSES = ['Pending', 'In Progress', 'Ready', 'Out for Delivery', 'Completed'];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeAdminPanel();
            }
        });

        signInAnonymously(auth).catch(error => {
            console.error("Anonymous sign-in failed:", error);
            alert("Could not connect to the server.");
        });

        function initializeAdminPanel() {
            listenForTables();
            listenForOrders();
            attachStaticEventListeners();
        }

        function listenForTables() {
            onSnapshot(collection(db, 'tables'), (snapshot) => {
                const tableGrid = document.getElementById('admin-table-grid');
                tableGrid.innerHTML = '';
                const tables = [];
                
                const batch = writeBatch(db);
                let changesMade = false;

                snapshot.forEach(doc => {
                    let table = {id: doc.id, ...doc.data()};

                    if (table.status === 'Cleaning' && table.cleaningUntil && table.cleaningUntil.toDate() <= new Date()) {
                        batch.update(doc.ref, { status: 'Available', cleaningUntil: null });
                        changesMade = true;
                        table.status = 'Available'; 
                    }
                    tables.push(table);
                });

                if (changesMade) {
                    batch.commit().catch(err => console.error("Error auto-updating table status:", err));
                }
                
                tables.sort((a, b) => {
                    const numA = (a.tableNumber && typeof a.tableNumber === 'string') ? parseInt(a.tableNumber.slice(1)) : 0;
                    const numB = (b.tableNumber && typeof b.tableNumber === 'string') ? parseInt(b.tableNumber.slice(1)) : 0;
                    return numA - numB;
                });

                tables.forEach(table => {
                    const tableEl = document.createElement('button');
                    tableEl.dataset.tableId = table.id;
                    let bgColor = 'bg-gray-200';
                    let statusText = table.status;
                    
                    if (table.needsWater || table.needsHelp) {
                        tableEl.classList.add('animate-flash-red', 'border-2');
                    }

                    switch(table.status) {
                        case 'Available': bgColor = 'bg-green-200'; break;
                        case 'Occupied': bgColor = 'bg-yellow-200'; break;
                        case 'Cleaning': bgColor = 'bg-blue-200'; break;
                        case 'Blocked': bgColor = 'bg-red-200'; break;
                    }

                    let alertsAndTimersHtml = '';
                    
                    if (table.status === 'Occupied' && table.availableTime) {
                        const freeIn = Math.round((table.availableTime.toDate() - new Date()) / 60000);
                        if (freeIn > 0) {
                            alertsAndTimersHtml += `<div class="text-xs text-blue-700 font-semibold mt-1">~${freeIn} min left</div>`;
                        }
                    }

                    if (table.status === 'Cleaning' && table.cleaningUntil) {
                        const cleanIn = Math.round((table.cleaningUntil.toDate() - new Date()) / 1000);
                        if (cleanIn > 0) {
                             alertsAndTimersHtml += `<div class="text-xs font-semibold mt-1">${cleanIn}s left</div>`;
                        }
                    }
                    
                    if (table.needsWater) {
                        alertsAndTimersHtml += `<div class="text-xs mt-1 font-bold bg-blue-500 text-white px-1 rounded-sm w-full">WATER</div>`;
                    }
                    if (table.needsHelp) {
                        alertsAndTimersHtml += `<div class="text-xs mt-1 font-bold bg-yellow-500 text-black px-1 rounded-sm w-full">HELP</div>`;
                    }
                    
                    tableEl.className = `p-2 rounded-lg text-center transition ${bgColor} flex flex-col justify-start min-h-[90px]`;
                    tableEl.innerHTML = `
                        <div class="font-bold">${table.tableNumber || 'N/A'} <span class="text-xs font-normal text-gray-700">(${table.capacity}p)</span></div>
                        <div class="text-sm">${statusText}</div>
                        <div class="flex-grow flex flex-col justify-end">
                            ${alertsAndTimersHtml}
                        </div>
                    `;
                    tableGrid.appendChild(tableEl);
                });
            });
        }
        
        function listenForOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startOfToday = Timestamp.fromDate(today);

            const q = query(collection(db, 'orders'), where('createdAt', '>=', startOfToday));
            
            onSnapshot(q, (snapshot) => {
                allTodayOrders = [];
                const activeOrders = [];
                let totalOrders = 0, totalRevenue = 0, totalPaid = 0, totalUnpaid = 0;

                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    allTodayOrders.push(order);
                    
                    totalOrders++;
                    totalRevenue += order.totalAmount;
                    if (order.paymentStatus === 'Paid') {
                        totalPaid += order.totalAmount;
                    } else {
                        totalUnpaid += order.totalAmount;
                    }

                    if (!order.isHidden) {
                        activeOrders.push(order);
                    }
                });
                
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-revenue').textContent = `₹${totalRevenue.toFixed(0)}`;
                document.getElementById('total-paid').textContent = `₹${totalPaid.toFixed(0)}`;
                document.getElementById('total-unpaid').textContent = `₹${totalUnpaid.toFixed(0)}`;
                
                renderKanban(activeOrders);
            });
        }
        
        function renderKanban(orders) {
            ORDER_STATUSES.forEach(status => {
                const colId = `col-${status.replace(/ /g, '')}`;
                const col = document.getElementById(colId);
                if(col) col.querySelector('.order-list').innerHTML = '';
            });
            
            orders.sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());

            orders.forEach(order => {
                const colId = `col-${order.status.replace(/ /g, '')}`;
                const col = document.getElementById(colId);
                if (!col) return;

                const card = document.createElement('div');
                card.className = 'p-3 bg-gray-50 rounded-md border border-gray-200';
                card.dataset.id = order.id;

                const paymentClass = order.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600';
                const paymentBg = order.paymentStatus === 'Paid' ? 'bg-green-100' : 'bg-red-100';

                card.innerHTML = `
                    <p class="font-bold">${order.customerName} (${order.whatsappNumber})</p>
                    <p class="text-sm text-gray-500">${order.orderType} ${order.tableId || ''}</p>
                    <p class="font-semibold my-1">₹${order.totalAmount.toFixed(0)}</p>
                    <div class="text-xs my-2">
                        ${Object.values(JSON.parse(order.items)).map(i => `${i.quantity}x ${i.name}`).join(', ')}
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        <button class="payment-toggle-btn ${paymentBg} ${paymentClass} px-2 py-1 rounded-full font-semibold" data-id="${order.id}" data-current="${order.paymentStatus}">
                            ${order.paymentStatus}
                        </button>
                        <div class="flex items-center gap-2">
                            <button class="whatsapp-btn bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" data-id="${order.id}">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                            </button>
                            ${renderNextStepButton(order)}
                        </div>
                    </div>
                `;
                col.querySelector('.order-list').appendChild(card);
            });
        }

        function renderNextStepButton(order) {
            const currentIdx = ORDER_STATUSES.indexOf(order.status);
            if (currentIdx < ORDER_STATUSES.length - 1) {
                const nextStatus = ORDER_STATUSES[currentIdx + 1];
                return `<button class="next-step-btn bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800" data-id="${order.id}" data-next-status="${nextStatus}">
                    &rarr; ${nextStatus}
                </button>`;
            }
            return '';
        }

        async function togglePaymentStatus(orderId, currentStatus) {
            const newStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
            await updateDoc(doc(db, 'orders', orderId), { paymentStatus: newStatus });
        }
        
        async function advanceOrderStatus(orderId, nextStatus) {
            await updateDoc(doc(db, 'orders', orderId), { status: nextStatus });
        }

        const modalBackdrop = document.getElementById('modal-backdrop');
        const tableModal = document.getElementById('table-modal');
        let currentTable = null; 

        async function openTableModal(tableId) {
            const tableRef = doc(db, 'tables', tableId);
            const tableSnap = await getDoc(tableRef);
            if (!tableSnap.exists()) { return; }
            currentTable = { id: tableSnap.id, ...tableSnap.data() };

            let helpRequestsHtml = '';
            if (currentTable.needsWater) {
                helpRequestsHtml += `<button data-type="needsWater" class="resolve-btn w-full text-left bg-yellow-100 text-yellow-800 p-2 rounded mb-2 hover:bg-yellow-200">Resolve Water Request</button>`;
            }
            if (currentTable.needsHelp) {
                helpRequestsHtml += `<button data-type="needsHelp" class="resolve-btn w-full text-left bg-yellow-100 text-yellow-800 p-2 rounded mb-2 hover:bg-yellow-200">Resolve Help Request</button>`;
            }
            
            tableModal.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">Manage Table ${currentTable.tableNumber}</h3>
                ${helpRequestsHtml}
                <div class="mb-4">
                    <p class="font-semibold mb-2">Change Status:</p>
                    <div class="grid grid-cols-2 gap-2">
                        ${['Available', 'Occupied', 'Blocked'].map(status => `<button data-status="${status}" class="status-change-btn p-2 rounded ${currentTable.status === status ? 'bg-brand text-white' : 'bg-gray-200'}">${status}</button>`).join('')}
                    </div>
                </div>
                <div class="mb-4">
                    <p class="font-semibold mb-2">Set estimated availability time (for Occupied tables):</p>
                     <div class="grid grid-cols-3 gap-2">
                        <button data-mins="10" class="time-set-btn p-2 bg-gray-200 rounded">10 min</button>
                        <button data-mins="20" class="time-set-btn p-2 bg-gray-200 rounded">20 min</button>
                        <button data-mins="30" class="time-set-btn p-2 bg-gray-200 rounded">30 min</button>
                    </div>
                </div>
                 <button id="close-table-modal" class="mt-4 w-full p-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>
            `;
            
            modalBackdrop.classList.remove('hidden');
            tableModal.classList.remove('hidden');
        }
        
        async function changeTableStatus(newStatus) {
            const tableRef = doc(db, 'tables', currentTable.id);
            let updateData = { status: newStatus };
            
            if (currentTable.status === 'Occupied' && newStatus === 'Available') {
                updateData = {
                    status: 'Cleaning',
                    orderId: null,
                    availableTime: null,
                    needsWater: false,
                    needsHelp: false,
                    cleaningUntil: Timestamp.fromDate(new Date(Date.now() + 2 * 60000))
                };
            } else if (newStatus === 'Available') {
                 updateData = { status: 'Available', orderId: null, availableTime: null, needsWater: false, needsHelp: false, cleaningUntil: null };
            }
            
            await updateDoc(tableRef, updateData);
            closeModals();
        }
        
        async function setTableTime(mins) {
            const availableTime = new Date(Date.now() + mins * 60000);
            await updateDoc(doc(db, 'tables', currentTable.id), { availableTime: Timestamp.fromDate(availableTime) });
            closeModals();
        }
        
        async function resolveHelpRequest(type) {
            await updateDoc(doc(db, 'tables', currentTable.id), { [type]: false });
            closeModals();
        }
        
        function closeModals() {
            modalBackdrop.classList.add('hidden');
            tableModal.classList.add('hidden');
            document.getElementById('log-modal').classList.add('hidden');
            currentTable = null;
        }

        function sendWhatsAppBill(orderId) {
            const order = allTodayOrders.find(o => o.id === orderId);
            if (!order) {
                alert("Order not found!");
                return;
            }

            let message = `Hello ${order.customerName},\n\nHere is your bill from Artevia Palette:\n\n`;
            message += "--------------------------------\n";
            Object.values(JSON.parse(order.items)).forEach(item => {
                const itemTotal = item.quantity * item.price;
                message += `${item.quantity} x ${item.name} - ₹${itemTotal.toFixed(2)}\n`;
            });
            message += "--------------------------------\n";
            message += `*Total Amount: ₹${order.totalAmount.toFixed(2)}*\n\n`;
            message += "Hope you enjoyed your meal! Please visit us again soon.\n";

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/91${order.whatsappNumber}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
        
        function attachStaticEventListeners() {
            document.querySelector('.kanban-container').addEventListener('click', (e) => {
                const paymentBtn = e.target.closest('.payment-toggle-btn');
                const nextStepBtn = e.target.closest('.next-step-btn');
                const whatsappBtn = e.target.closest('.whatsapp-btn');

                if (paymentBtn) {
                    togglePaymentStatus(paymentBtn.dataset.id, paymentBtn.dataset.current);
                }
                if (nextStepBtn) {
                    advanceOrderStatus(nextStepBtn.dataset.id, nextStepBtn.dataset.nextStatus);
                }
                if (whatsappBtn) {
                    sendWhatsAppBill(whatsappBtn.dataset.id);
                }
            });

            document.getElementById('admin-table-grid').addEventListener('click', (e) => {
                const tableButton = e.target.closest('button');
                if (tableButton && tableButton.dataset.tableId) {
                    openTableModal(tableButton.dataset.tableId);
                }
            });

            tableModal.addEventListener('click', (e) => {
                const statusBtn = e.target.closest('.status-change-btn');
                const timeBtn = e.target.closest('.time-set-btn');
                const resolveBtn = e.target.closest('.resolve-btn');
                if (e.target.id === 'close-table-modal') closeModals();
                if (statusBtn) changeTableStatus(statusBtn.dataset.status);
                if (timeBtn) setTableTime(timeBtn.dataset.mins);
                if (resolveBtn) resolveHelpRequest(resolveBtn.dataset.type);
            });

            document.getElementById('archive-btn').onclick = async () => {
                const q = query(collection(db, 'orders'), where('status', '==', 'Completed'), where('paymentStatus', '==', 'Paid'));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(docSnap => batch.update(docSnap.ref, { isHidden: true }));
                await batch.commit();
                alert(`${snapshot.size} orders archived.`);
            };

            document.getElementById('download-pdf-btn').onclick = () => {
                const doc = new jsPDF();
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-IN');
                let y = 15;

                doc.setFontSize(20);
                doc.text("Artevia Palette - Daily Order Report", 105, y, { align: 'center' });
                y += 5;
                doc.setFontSize(12);
                doc.text(`Date: ${formattedDate}`, 105, y, { align: 'center' });
                y += 10;

                allTodayOrders.sort((a,b) => a.createdAt.toDate() - b.createdAt.toDate()).forEach(order => {
                    if (y > 270) {
                        doc.addPage();
                        y = 15;
                    }

                    const time = order.createdAt.toDate().toLocaleTimeString('en-IN');
                    const customerInfo = `${order.customerName} (${order.whatsappNumber})`;
                    const orderInfo = `${order.orderType} ${order.tableId || ''} - ${time}`;
                    const items = Object.values(JSON.parse(order.items)).map(i => `${i.quantity}x ${i.name} (₹${i.price.toFixed(2)})`).join(', ');
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(customerInfo, 14, y);
                    y+= 6;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(orderInfo, 14, y);
                    doc.text(`Total: ₹${order.totalAmount.toFixed(2)}`, 195, y, { align: 'right' });
                    y += 6;
                    
                    doc.text(`Items: ${items}`, 14, y, { maxWidth: 180 });
                    y += 10;
                    
                    doc.text(`Status: ${order.status} / ${order.paymentStatus}`, 14, y);
                    y += 5;

                    doc.setLineWidth(0.2);
                    doc.line(14, y, 195, y);
                    y += 8;
                });

                doc.save(`daily_orders_${today.toISOString().split('T')[0]}.pdf`);
            };
            
            document.getElementById('view-log-btn').onclick = () => {
                 const logContent = document.getElementById('log-content');
                 logContent.innerHTML = '';
                 const groupedByCustomer = allTodayOrders.reduce((acc, order) => {
                    (acc[order.whatsappNumber] = acc[order.whatsappNumber] || []).push(order);
                    return acc;
                 }, {});
                 
                 for (const number in groupedByCustomer) {
                     const orders = groupedByCustomer[number].sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
                     const customerName = orders[0].customerName;
                     const customerDiv = document.createElement('div');
                     customerDiv.className = 'mb-6';
                     customerDiv.innerHTML = `<h4 class="font-bold text-lg mb-2">${customerName} - ${number}</h4>`;
                     orders.forEach(order => {
                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'p-3 bg-gray-50 rounded border mb-2';
                         orderDiv.innerHTML = `
                            <div class="flex justify-between items-center text-sm">
                                <span>${order.createdAt.toDate().toLocaleTimeString()} - ${order.orderType} ${order.tableId || ''}</span>
                                <span>Status: ${order.status} / ${order.paymentStatus}</span>
                                <span class="font-bold">₹${order.totalAmount.toFixed(0)}</span>
                            </div>
                         `;
                         customerDiv.appendChild(orderDiv);
                     });
                     logContent.appendChild(customerDiv);
                 }

                 document.getElementById('log-modal').classList.remove('hidden');
                 modalBackdrop.classList.remove('hidden');
            };

            document.getElementById('close-log-btn').onclick = closeModals;
            modalBackdrop.onclick = closeModals;
        }

    </script>
</body>
</html>

