<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Editor - Artevia Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-brand { background-color: #a43c1a; }
        .hover\:bg-brand-dark:hover { background-color: #8a3216; }
        .text-brand { color: #a43c1a; }
        .border-brand { border-color: #a43c1a; }
        .ring-brand:focus { --tw-ring-color: #a43c1a; }
        th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* gray-50 */
            z-index: 10;
        }
        .editable-input:disabled, .editable-select:disabled {
            background-color: transparent;
            border-color: transparent;
            color: #374151; /* gray-700 */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-left: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <div class="text-center bg-brand p-4">
                <img src="https://raw.githubusercontent.com/Sarup098/artevia/main/Artevia_Palette_Logo.png" alt="Artevia Palette Logo" class="h-24 w-auto mx-auto mb-2">
                <h1 class="text-2xl font-bold text-white">Menu Editor</h1>
                <p class="text-gray-200">Manage your existing menu and add new items in bulk.</p>
            </div>
            
            <div class="p-4 border-b">
                <h2 class="font-bold text-lg mb-2 text-gray-800">Manage Existing Menu</h2>
                <div id="existing-menu-container" class="max-h-[50vh] overflow-y-auto">
                    <p id="loading-existing" class="text-gray-500">Loading existing items...</p>
                    <table class="w-full text-sm hidden">
                        <thead class="text-left text-gray-700">
                            <tr>
                                <th class="px-2 py-3">Item Name</th>
                                <th class="px-2 py-3">Price</th>
                                <th class="px-2 py-3">Category</th>
                                <th class="px-2 py-3">Type</th>
                                <th class="px-2 py-3">Image Link</th>
                                <th class="px-2 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="existing-menu-body" class="divide-y">
                            <!-- JS will populate this with editable rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section for adding new items -->
            <div class="p-4 border-b">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-lg text-gray-800">Add New Items</h2>
                    <!-- NEW: Category pre-fill dropdown -->
                    <div class="flex items-center gap-2">
                        <label for="prefill-category" class="text-sm font-medium">Pre-fill Category:</label>
                        <select id="prefill-category" class="p-1 border rounded text-xs"></select>
                    </div>
                </div>
                <div class="max-h-[40vh] overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="text-left text-gray-700">
                            <tr>
                                <th class="px-2 py-3 w-1/12">#</th>
                                <th class="px-2 py-3 w-3/12">Name*</th>
                                <th class="px-2 py-3 w-1/12">Price*</th>
                                <th class="px-2 py-3 w-2/12">Category*</th>
                                <th class="px-2 py-3 w-1/12">Type*</th>
                                <th class="px-2 py-3 w-4/12">Image Link*</th>
                            </tr>
                        </thead>
                        <tbody id="menu-form-body" class="divide-y">
                            <!-- Rows will be generated here by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- NEW: Add more rows button -->
                <div class="mt-2 text-center">
                    <button id="add-more-rows-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold">+ Add 5 More Rows</button>
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t">
                 <button id="save-all-btn" class="w-full bg-brand text-white font-bold py-3 px-4 rounded-md hover:bg-brand-dark transition duration-300">
                    Save All New Items to Menu
                </button>
                 <p id="status-message" class="mt-4 text-center font-semibold"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, writeBatch, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.firebasestorage.app",
            messagingSenderId: "424044050877",
            appId: "1:424044050877:web:9ea875314de19b70173ad4",
            measurementId: "G-XNVCLD42Y4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const formBody = document.getElementById('menu-form-body');
        const saveBtn = document.getElementById('save-all-btn');
        const statusMessage = document.getElementById('status-message');
        const existingMenuContainer = document.getElementById('existing-menu-container');
        const existingMenuBody = document.getElementById('existing-menu-body');
        const prefillCategorySelect = document.getElementById('prefill-category');
        const addMoreRowsBtn = document.getElementById('add-more-rows-btn');
        
        let existingItems = [];
        let addRowCount = 0;

        const levenshteinDistance = (s1, s2) => {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        };


        function listenForExistingMenu() {
            onSnapshot(collection(db, "menu"), (querySnapshot) => {
                const loadingMsg = document.getElementById('loading-existing');
                const table = existingMenuContainer.querySelector('table');

                if (querySnapshot.empty) {
                    table.classList.add('hidden');
                    loadingMsg.textContent = 'No menu items found in the database.';
                    loadingMsg.classList.remove('hidden');
                    existingItems = [];
                    return;
                }
                
                table.classList.remove('hidden');
                loadingMsg.classList.add('hidden');
                
                existingItems = [];
                querySnapshot.forEach(doc => existingItems.push({ id: doc.id, ...doc.data() }));

                const menuByCategory = existingItems.reduce((acc, item) => {
                    const category = item.category || 'Uncategorized';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});

                const sortedCategories = Object.keys(menuByCategory).sort();
                let allRowsHtml = '';

                // NEW: Populate pre-fill dropdown
                prefillCategorySelect.innerHTML = '<option value="">Select to pre-fill...</option>' + sortedCategories.map(c => `<option value="${c}">${c}</option>`).join('');

                sortedCategories.forEach(category => {
                    allRowsHtml += `<tr class="bg-gray-100"><td colspan="6" class="px-2 py-2 font-bold text-gray-800">${category}</td></tr>`;
                    menuByCategory[category]
                        .sort((a,b) => a.name.localeCompare(b.name))
                        .forEach(item => {
                            const isVeg = item.vegStatus === 'veg';
                            allRowsHtml += `
                                <tr class="existing-item-row" data-id="${item.id}">
                                    <td class="px-2 py-1"><input type="text" value="${item.name}" class="edit-name w-full p-1 border rounded text-xs editable-input" disabled></td>
                                    <td class="px-2 py-1"><input type="number" value="${item.price}" class="edit-price w-full p-1 border rounded text-xs editable-input" disabled></td>
                                    <td class="px-2 py-1"><input type="text" value="${item.category}" class="edit-category w-full p-1 border rounded text-xs editable-input" disabled></td>
                                    <td class="px-2 py-1">
                                        <select class="edit-veg-status w-full p-1 border rounded text-xs editable-select" disabled>
                                            <option value="veg" ${isVeg ? 'selected' : ''}>Veg</option>
                                            <option value="non-veg" ${!isVeg ? 'selected' : ''}>Non-Veg</option>
                                        </select>
                                    </td>
                                    <td class="px-2 py-1"><input type="url" value="${item.imageUrl || ''}" class="edit-image-url w-full p-1 border rounded text-xs editable-input" disabled></td>
                                    <td class="px-2 py-1 text-center">
                                        <button class="edit-btn text-blue-600 hover:text-blue-800 text-xs font-semibold">Edit</button>
                                        <button class="save-btn text-green-600 hover:text-green-800 text-xs font-semibold hidden">Save</button>
                                        <button class="cancel-btn text-gray-600 hover:text-gray-800 text-xs font-semibold hidden">Cancel</button>
                                        <button class="delete-btn text-red-600 hover:text-red-800 text-xs font-semibold ml-2">Delete</button>
                                    </td>
                                </tr>`;
                        });
                });
                existingMenuBody.innerHTML = allRowsHtml;
            });
        }

        existingMenuBody.addEventListener('click', async (e) => {
            const row = e.target.closest('.existing-item-row');
            if (!row) return;
            const itemId = row.dataset.id;
            const inputs = row.querySelectorAll('.editable-input, .editable-select');

            if (e.target.matches('.edit-btn')) {
                inputs.forEach(input => input.disabled = false);
                row.querySelector('.edit-btn').classList.add('hidden');
                row.querySelector('.save-btn').classList.remove('hidden');
                row.querySelector('.cancel-btn').classList.remove('hidden');
            }

            if (e.target.matches('.cancel-btn')) {
                // To-do: reset to original values
                inputs.forEach(input => input.disabled = true);
                row.querySelector('.edit-btn').classList.remove('hidden');
                row.querySelector('.save-btn').classList.add('hidden');
                row.querySelector('.cancel-btn').classList.add('hidden');
            }

            if (e.target.matches('.save-btn')) {
                const updatedData = {
                    name: row.querySelector('.edit-name').value,
                    price: parseFloat(row.querySelector('.edit-price').value),
                    category: row.querySelector('.edit-category').value,
                    vegStatus: row.querySelector('.edit-veg-status').value,
                    imageUrl: row.querySelector('.edit-image-url').value,
                };
                try {
                    await updateDoc(doc(db, "menu", itemId), updatedData);
                    inputs.forEach(input => input.disabled = true);
                    row.querySelector('.edit-btn').classList.remove('hidden');
                    row.querySelector('.save-btn').classList.add('hidden');
                    row.querySelector('.cancel-btn').classList.add('hidden');
                } catch (error) {
                    console.error("Error updating item: ", error);
                    alert("Failed to update item.");
                }
            }

            if (e.target.matches('.delete-btn')) {
                if (confirm('Are you sure you want to delete this item permanently?')) {
                    try {
                        await deleteDoc(doc(db, "menu", itemId));
                    } catch (error) {
                        console.error("Error deleting item: ", error);
                        alert("Failed to delete item.");
                    }
                }
            }
        });

        // NEW: Function to add a specified number of rows
        function addMoreInputRows(count) {
            let rowsHtml = '';
            for (let i = 1; i <= count; i++) {
                rowsHtml += `
                    <tr class="add-item-row">
                        <td class="px-2 py-1 text-center text-gray-500">${addRowCount + i}</td>
                        <td class="px-2 py-1"><input type="text" placeholder="Item Name" class="item-name w-full p-1 border rounded text-xs"></td>
                        <td class="px-2 py-1"><input type="number" placeholder="â‚¹" class="item-price w-full p-1 border rounded text-xs"></td>
                        <td class="px-2 py-1"><input type="text" placeholder="Category" class="item-category w-full p-1 border rounded text-xs"></td>
                        <td class="px-2 py-1">
                            <select class="item-veg-status w-full p-1 border rounded text-xs">
                                <option value="veg" selected>Veg</option>
                                <option value="non-veg">Non-Veg</option>
                            </select>
                        </td>
                        <td class="px-2 py-1"><input type="url" placeholder="Image URL" class="item-image-url w-full p-1 border rounded text-xs"></td>
                    </tr>`;
            }
            formBody.innerHTML += rowsHtml;
            addRowCount += count;
        }
        
        addMoreRowsBtn.addEventListener('click', () => addMoreInputRows(5));

        prefillCategorySelect.addEventListener('change', (e) => {
            const category = e.target.value;
            if (!category) return;
            document.querySelectorAll('.add-item-row .item-category').forEach(input => {
                if (!input.value) { // Only fill if empty
                    input.value = category;
                }
            });
        });

        saveBtn.addEventListener('click', async () => {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            statusMessage.textContent = '';
            document.querySelectorAll('.add-item-row').forEach(r => r.classList.remove('bg-red-100', 'bg-yellow-100'));

            const itemsToAdd = [];
            const addRows = document.querySelectorAll('.add-item-row');
            let validationFailed = false;
            const existingItemNamesLower = existingItems.map(item => item.name.toLowerCase().trim());

            for (const row of addRows) {
                const nameInput = row.querySelector('.item-name');
                const priceInput = row.querySelector('.item-price');
                if (!nameInput.value.trim() || !priceInput.value) continue;

                const itemName = nameInput.value.trim();
                const itemNameLower = itemName.toLowerCase();

                if (existingItemNamesLower.includes(itemNameLower)) {
                    statusMessage.textContent = `Error: Item "${itemName}" already exists.`;
                    statusMessage.className = 'mt-4 text-center font-semibold text-red-600';
                    row.classList.add('bg-red-100');
                    validationFailed = true;
                    break;
                }
                
                let similarItem = null;
                for (const existingName of existingItemNamesLower) {
                    const distance = levenshteinDistance(itemNameLower, existingName);
                    if (distance > 0 && distance <= 2) {
                        similarItem = existingItems.find(i => i.name.toLowerCase().trim() === existingName);
                        break;
                    }
                }

                if (similarItem) {
                    if (!confirm(`Warning: The name "${itemName}" is very similar to "${similarItem.name}".\nDo you want to add it anyway?`)) {
                        statusMessage.textContent = 'Save cancelled. Please review the highlighted item.';
                        statusMessage.className = 'mt-4 text-center font-semibold text-yellow-600';
                        row.classList.add('bg-yellow-100');
                        validationFailed = true;
                        break;
                    }
                }

                itemsToAdd.push({
                    name: itemName,
                    price: parseFloat(priceInput.value),
                    category: row.querySelector('.item-category').value.trim() || 'Uncategorized',
                    vegStatus: row.querySelector('.item-veg-status').value,
                    imageUrl: row.querySelector('.item-image-url').value.trim(),
                    description: '',
                    discount: 0,
                    stockStatus: 'in_stock'
                });
            }

            if (validationFailed) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save All New Items to Menu';
                return;
            }

            if (itemsToAdd.length === 0) {
                statusMessage.textContent = 'No new items to add. Please fill out at least one row.';
                statusMessage.className = 'mt-4 text-center font-semibold text-yellow-600';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save All New Items to Menu';
                return;
            }

            const batch = writeBatch(db);
            itemsToAdd.forEach(item => {
                const newDocRef = doc(collection(db, "menu"));
                batch.set(newDocRef, item);
            });

            try {
                await batch.commit();
                statusMessage.textContent = `Successfully added ${itemsToAdd.length} new items!`;
                statusMessage.className = 'mt-4 text-center font-semibold text-green-600';
                formBody.innerHTML = ''; // Clear the form
                addRowCount = 0;
                addMoreInputRows(5); // Add fresh 5 rows
            } catch (error) {
                console.error("Error adding items in bulk: ", error);
                statusMessage.textContent = 'An error occurred. Check the console.';
                statusMessage.className = 'mt-4 text-center font-semibold text-red-600';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save All New Items to Menu';
            }
        });

        // Initial setup
        listenForExistingMenu();
        addMoreInputRows(5); // Start with 5 rows

    </script>
</body>
</html>

