<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artevia Cafe Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .menu-item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .category-filter-container {
            position: sticky; top: 0; background-color: #f9fafb; z-index: 10;
            padding: 0.75rem 0; overflow-x: auto; white-space: nowrap;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .category-filter-container::-webkit-scrollbar { display: none; }
        .category-btn.active { background-color: #78350f; color: white; font-weight: 600; }
        .menu-item-image {
            height: 150px;
            object-fit: cover;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Order Type Selection Modal -->
    <div id="order-type-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
            <h2 class="text-3xl font-bold text-yellow-900 mb-6">How would you like to order?</h2>
            <div class="space-y-4">
                <button id="dine-in-btn" class="w-full bg-yellow-800 text-white py-4 rounded-lg font-semibold text-lg hover:bg-yellow-900 transition transform hover:scale-105">Dine-In</button>
                <button id="delivery-btn" class="w-full bg-green-700 text-white py-4 rounded-lg font-semibold text-lg hover:bg-green-800 transition transform hover:scale-105">Local Delivery (Majitar)</button>
            </div>
        </div>
    </div>

    <!-- Main Container (Initially hidden) -->
    <div id="main-container" class="container mx-auto max-w-2xl p-4 hidden">
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-yellow-900">Artevia Cafe</h1>
            <p id="header-subtitle" class="text-gray-600 mt-2 text-lg"></p>
        </header>

        <div class="category-filter-container mb-6 shadow-sm">
            <div id="category-filters" class="flex gap-2 px-4"></div>
        </div>
        
        <div id="menu-items" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
             <!-- Menu items will be dynamically inserted here -->
             <div class="text-center sm:col-span-2 text-gray-500 py-10">Loading menu...</div>
        </div>

        <div class="fixed bottom-6 right-6 z-20">
            <button id="view-cart-btn" class="bg-yellow-800 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </div>

    <!-- Modals (Cart, Customer, Success) -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b"><h2 class="text-2xl font-semibold">Your Order</h2></div>
            <div id="cart-items" class="p-6 max-h-64 overflow-y-auto"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-lg">
                <div class="flex justify-between items-center font-bold text-xl">
                    <span>Total:</span><span id="cart-total">â‚¹0.00</span>
                </div>
                <button id="place-order-btn" class="w-full bg-green-600 text-white py-3 rounded-lg mt-4 font-semibold hover:bg-green-700 transition">Place Order</button>
                <button id="close-cart-btn" class="w-full bg-gray-300 text-gray-800 py-3 rounded-lg mt-2 hover:bg-gray-400 transition">Close</button>
            </div>
        </div>
    </div>
    <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h2 class="text-2xl font-semibold mb-4 text-center">Final Step</h2>
            <p class="text-center text-gray-600 mb-4">We'll send the bill to your WhatsApp.</p>
            <div class="space-y-4">
                <input type="tel" id="whatsapp-number" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-800" placeholder="Enter WhatsApp Number">
                <input type="text" id="customer-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-800 hidden" placeholder="Enter Your Name">
                <textarea id="delivery-address" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-800 hidden" placeholder="Enter Full Delivery Address" rows="3"></textarea>
            </div>
            <button id="submit-order-btn" class="w-full bg-yellow-800 text-white py-3 rounded-lg mt-6 font-semibold hover:bg-yellow-900 transition">Confirm & Order</button>
            <button id="close-customer-modal-btn" class="w-full bg-gray-300 text-gray-800 py-3 rounded-lg mt-2 hover:bg-gray-400 transition">Cancel</button>
        </div>
    </div>
    <div id="success-message" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hidden z-50">Order placed successfully!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.appspot.com",
            messagingSenderId: "424044050877",
            appId: "1:42044050877:web:2c67d2d065d3411e173ad4",
            measurementId: "G-M5S8PYDFZ5"
        };
        
        async function main() {
            let db, auth;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase init failed:", error);
                document.body.innerHTML = `<div class="p-4 text-red-500 text-center"><strong>Firebase Connection Error.</strong><br>Please ensure "Anonymous" sign-in is enabled in your Firebase project's Authentication settings.</div>`;
                return; // Stop execution if Firebase fails
            }

            // --- DOM Elements ---
            const allDOMElements = {
                orderTypeModal: document.getElementById('order-type-modal'), dineInBtn: document.getElementById('dine-in-btn'),
                deliveryBtn: document.getElementById('delivery-btn'), mainContainer: document.getElementById('main-container'),
                headerSubtitle: document.getElementById('header-subtitle'), deliveryAddressInput: document.getElementById('delivery-address'),
                categoryFiltersContainer: document.getElementById('category-filters'), menuItemsContainer: document.getElementById('menu-items'),
                cartCountEl: document.getElementById('cart-count'), viewCartBtn: document.getElementById('view-cart-btn'),
                cartModal: document.getElementById('cart-modal'), closeCartBtn: document.getElementById('close-cart-btn'),
                cartItemsContainer: document.getElementById('cart-items'), cartTotalEl: document.getElementById('cart-total'),
                placeOrderBtn: document.getElementById('place-order-btn'), customerModal: document.getElementById('customer-modal'),
                closeCustomerModalBtn: document.getElementById('close-customer-modal-btn'), whatsappNumberInput: document.getElementById('whatsapp-number'),
                customerNameInput: document.getElementById('customer-name'), submitOrderBtn: document.getElementById('submit-order-btn'),
                successMessage: document.getElementById('success-message'),
            };
            
            // --- App State ---
            let cart = []; let menu = []; let tableNumber = null;
            let orderMode = ''; let activeCategory = 'All';
            let isWaitingForNewName = false;

            const initializeMenu = (mode) => {
                orderMode = mode;
                allDOMElements.orderTypeModal.classList.add('hidden');
                allDOMElements.mainContainer.classList.remove('hidden');

                if (orderMode === 'dine-in') {
                    const urlParams = new URLSearchParams(window.location.search);
                    tableNumber = urlParams.get('table');
                    if (!tableNumber) {
                        allDOMElements.mainContainer.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl font-bold text-red-600">Error: Table Number Not Found</h1><p class="text-gray-600">Please scan a valid QR code.</p></div>`;
                        return;
                    }
                    allDOMElements.headerSubtitle.innerHTML = `Welcome to Table <span class="font-bold">${tableNumber}</span>`;
                } else {
                    allDOMElements.headerSubtitle.textContent = 'Your Local Delivery Hub';
                    allDOMElements.deliveryAddressInput.classList.remove('hidden');
                }
                listenToMenuChanges();
            };
            
            const listenToMenuChanges = () => {
                const menuQuery = query(collection(db, `menu`));
                onSnapshot(menuQuery, (snapshot) => {
                    menu = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCategories();
                    renderMenu();
                }, (error) => {
                    console.error("Menu snapshot listener error: ", error);
                    allDOMElements.menuItemsContainer.innerHTML = `<p class="text-red-500 text-center md:col-span-2">Error loading menu. Please try again later.</p>`;
                });
            };

            const renderCategories = () => {
                const categories = ['All', ...new Set(menu.map(item => item.category || 'Other'))];
                allDOMElements.categoryFiltersContainer.innerHTML = categories.map(category => `
                    <button class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 whitespace-nowrap ${category === activeCategory ? 'active' : ''}" data-category="${category}">
                        ${category}
                    </button>
                `).join('');
            };

            const renderMenu = () => {
                const container = allDOMElements.menuItemsContainer;
                const filteredMenu = activeCategory === 'All' ? menu : menu.filter(item => item.category === activeCategory);
                container.innerHTML = filteredMenu.length === 0 ? `<p class="text-gray-500 text-center sm:col-span-2">No items available. Use the Menu Manager to add dishes.</p>` : '';
                
                filteredMenu.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow menu-item-card overflow-hidden';
                    const hasDiscount = item.discount > 0;
                    const finalPrice = hasDiscount ? item.price * (1 - item.discount / 100) : item.price;

                    card.innerHTML = `
                        <img src="${item.imageUrl || 'https://placehold.co/400x300/F5F5F5/333333?text=No+Image'}" alt="${item.name}" class="menu-item-image">
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-semibold text-yellow-900">${item.name}</h3>
                            <p class="text-sm text-gray-500 mt-1 flex-grow">${item.description || ''}</p>
                            <div class="flex justify-between items-center mt-4">
                                <div>
                                    <span class="text-lg font-bold text-gray-800">â‚¹${finalPrice.toFixed(2)}</span>
                                    ${hasDiscount ? `<span class="ml-2 text-sm text-gray-400 line-through">â‚¹${item.price.toFixed(2)}</span>` : ''}
                                </div>
                                <button data-id="${item.id}" class="add-to-cart-btn bg-yellow-800 text-white px-4 py-2 rounded-lg hover:bg-yellow-900 transition text-sm font-semibold">Add</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            };

            const addToCart = (itemId) => {
                const menuItem = menu.find(item => item.id === itemId);
                if (!menuItem) return;
                const cartItem = cart.find(item => item.id === itemId);

                const hasDiscount = menuItem.discount > 0;
                const finalPrice = hasDiscount ? menuItem.price * (1 - menuItem.discount / 100) : menuItem.price;
                
                if (cartItem) {
                    cartItem.quantity++;
                } else {
                    cart.push({ ...menuItem, quantity: 1, finalPrice });
                }
                updateCartUI();
            };
            
            const removeFromCart = (itemId) => {
                const cartItemIndex = cart.findIndex(item => item.id === itemId);
                if (cartItemIndex > -1) {
                    cart[cartItemIndex].quantity--;
                    if (cart[cartItemIndex].quantity === 0) cart.splice(cartItemIndex, 1);
                }
                updateCartUI();
            };

            const updateCartUI = () => {
                const { cartCountEl, cartItemsContainer, placeOrderBtn, cartTotalEl } = allDOMElements;
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCountEl.textContent = totalItems;
                cartItemsContainer.innerHTML = cart.length === 0 ? '<p class="text-gray-500 text-center">Your cart is empty.</p>' : '';
                placeOrderBtn.disabled = cart.length === 0;
                placeOrderBtn.classList.toggle('opacity-50', cart.length === 0);
                
                let total = 0;
                cart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center py-2';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500">â‚¹${item.finalPrice.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold">â‚¹${(item.finalPrice * item.quantity).toFixed(2)}</span>
                            <button data-id="${item.id}" class="remove-from-cart-btn text-red-500 hover:text-red-700 font-bold text-lg">X</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                    total += item.finalPrice * item.quantity;
                });
                cartTotalEl.textContent = `â‚¹${total.toFixed(2)}`;
            };
            
            const handlePlaceOrder = async () => {
                const { whatsappNumberInput, deliveryAddressInput, customerNameInput, submitOrderBtn } = allDOMElements;

                if (isWaitingForNewName) {
                    const name = customerNameInput.value.trim();
                    const number = whatsappNumberInput.value.trim();
                    if (name) {
                        customerNameInput.classList.remove('ring-2', 'ring-red-500');
                        submitOrder(name, number, true);
                    } else {
                        customerNameInput.focus();
                        customerNameInput.classList.add('ring-2', 'ring-red-500');
                    }
                    return;
                }

                const number = whatsappNumberInput.value.trim();
                if (number.length < 10 || !/^\d+$/.test(number)) {
                    whatsappNumberInput.focus();
                    whatsappNumberInput.classList.add('ring-2', 'ring-red-500');
                    return;
                }
                whatsappNumberInput.classList.remove('ring-2', 'ring-red-500');

                if (orderMode === 'delivery' && deliveryAddressInput.value.trim().length < 10) {
                     deliveryAddressInput.focus();
                     deliveryAddressInput.classList.add('ring-2', 'ring-red-500');
                     return;
                }
                deliveryAddressInput.classList.remove('ring-2', 'ring-red-500');

                try {
                    submitOrderBtn.disabled = true;
                    submitOrderBtn.textContent = 'Checking...';
                    const customerRef = doc(db, 'customers', number);
                    const customerSnap = await getDoc(customerRef);

                    if (customerSnap.exists()) {
                        customerNameInput.value = customerSnap.data().name;
                        customerNameInput.classList.add('hidden');
                        await submitOrder(customerSnap.data().name, number);
                    } else {
                        isWaitingForNewName = true;
                        customerNameInput.classList.remove('hidden');
                        customerNameInput.focus();
                        submitOrderBtn.textContent = 'Confirm & Order';
                        submitOrderBtn.disabled = false;
                    }
                } catch (error) {
                    console.error("Error checking customer: ", error);
                    submitOrderBtn.disabled = false;
                    submitOrderBtn.textContent = 'Confirm & Order';
                }
            };

            const submitOrder = async (name, number, isNewCustomer = false) => {
                if (cart.length === 0) return;
                const { submitOrderBtn, whatsappNumberInput, customerNameInput, deliveryAddressInput, customerModal, cartModal, successMessage } = allDOMElements;
                submitOrderBtn.disabled = true;
                submitOrderBtn.textContent = 'Placing Order...';

                const totalAmount = cart.reduce((sum, item) => sum + item.finalPrice * item.quantity, 0);
                const simplifiedCart = cart.map(item => ({
                    id: item.id, name: item.name, quantity: item.quantity,
                    price: item.price, finalPrice: item.finalPrice, discount: item.discount || 0
                }));
                
                let orderData = {
                    orderType: orderMode, customerName: name, whatsappNumber: number,
                    items: JSON.stringify(simplifiedCart), totalAmount: totalAmount,
                    status: 'Pending', timestamp: serverTimestamp()
                };

                if (orderMode === 'dine-in') orderData.tableNumber = tableNumber;
                else orderData.deliveryAddress = deliveryAddressInput.value.trim();

                try {
                    if (isNewCustomer) await setDoc(doc(db, 'customers', number), { name, whatsappNumber: number });
                    await addDoc(collection(db, 'orders'), orderData);
                    cart = []; updateCartUI();
                    customerModal.classList.add('hidden'); cartModal.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    setTimeout(() => successMessage.classList.add('hidden'), 3000);
                } catch (error) { console.error("Error placing order: ", error);
                } finally {
                    submitOrderBtn.disabled = false; submitOrderBtn.textContent = 'Confirm & Order';
                    whatsappNumberInput.value = ''; customerNameInput.value = ''; deliveryAddressInput.value = '';
                    customerNameInput.classList.add('hidden');
                    isWaitingForNewName = false;
                }
            };

            // --- Event Listeners ---
            allDOMElements.dineInBtn.addEventListener('click', () => initializeMenu('dine-in'));
            allDOMElements.deliveryBtn.addEventListener('click', () => initializeMenu('delivery'));
            allDOMElements.categoryFiltersContainer.addEventListener('click', (e) => {
                if (e.target.matches('.category-btn')) {
                    activeCategory = e.target.dataset.category;
                    renderCategories(); renderMenu();
                }
            });
            allDOMElements.menuItemsContainer.addEventListener('click', e => e.target.classList.contains('add-to-cart-btn') && addToCart(e.target.dataset.id));
            allDOMElements.cartItemsContainer.addEventListener('click', e => e.target.classList.contains('remove-from-cart-btn') && removeFromCart(e.target.dataset.id));
            allDOMElements.viewCartBtn.addEventListener('click', () => allDOMElements.cartModal.classList.remove('hidden'));
            allDOMElements.closeCartBtn.addEventListener('click', () => allDOMElements.cartModal.classList.add('hidden'));
            allDOMElements.placeOrderBtn.addEventListener('click', () => allDOMElements.customerModal.classList.remove('hidden'));
            allDOMElements.closeCustomerModalBtn.addEventListener('click', () => {
                allDOMElements.customerModal.classList.add('hidden');
                isWaitingForNewName = false;
                allDOMElements.customerNameInput.classList.add('hidden');
                allDOMElements.submitOrderBtn.textContent = 'Confirm & Order';
            });
            allDOMElements.submitOrderBtn.addEventListener('click', handlePlaceOrder);
        }

        main();
    </script>
</body>
</html>

