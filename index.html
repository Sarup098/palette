<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artevia Palette - Order Now</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.16/24/solid/styles.min.css" rel="stylesheet">
    <style>
        .bg-brand { background-color: #a43c1a; }
        .text-brand { color: #a43c1a; }
        .border-brand { border-color: #a43c1a; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { background-color: white; color: #a43c1a; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .veg-filter-active { background-color: #22c55e !important; border-color: #22c55e !important; color: white !important; }
        .nonveg-filter-active { background-color: #ef4444 !important; border-color: #ef4444 !important; color: white !important; }
        .category-circle-active { border: 4px solid #a43c1a; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .category-tab-active { color: #a43c1a; font-weight: 700; border-bottom: 2px solid #a43c1a; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Main Container -->
    <div class="container mx-auto max-w-lg bg-white min-h-screen shadow-lg">
        <header class="text-center p-4 bg-brand text-white sticky top-0 z-20">
             <img src="https://raw.githubusercontent.com/Sarup098/artevia/main/Artevia_Palette_Logo.png" alt="Artevia Palette Logo" class="h-16 w-auto mx-auto">
        </header>

        <div class="p-4">
            <!-- Order Type Tabs -->
            <div class="bg-gray-200 rounded-full flex p-1 mb-4">
                <button data-type="Dine-in" class="order-type-btn w-1/3 py-2 rounded-full font-semibold tab-active">Dine in</button>
                <button data-type="Takeaway" class="order-type-btn w-1/3 py-2 rounded-full font-semibold text-gray-500 cursor-not-allowed relative" disabled>Takeaway <span class="absolute -top-1 right-0 text-xs font-semibold bg-gray-400 text-white px-2 py-0.5 rounded-full">SOON</span></button>
                <button data-type="Delivery" class="order-type-btn w-1/3 py-2 rounded-full font-semibold text-gray-500 cursor-not-allowed relative" disabled>Delivery <span class="absolute -top-1 right-0 text-xs font-semibold bg-gray-400 text-white px-2 py-0.5 rounded-full">SOON</span></button>
            </div>

             <a href="#" id="food-plan-link" class="block w-full bg-yellow-100 border border-yellow-300 text-yellow-800 text-center p-4 rounded-lg shadow-sm hover:bg-yellow-200 transition mb-4">
                <h3 class="font-bold text-lg">Monthly food plan (Pg)</h3>
                <p class="text-sm font-semibold">Early bird offer available!</p>
            </a>

            <!-- Search and Filters -->
            <div class="flex items-center gap-2 mb-4">
                <input type="text" id="search-bar" placeholder="Search for your favourite dish..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-brand focus:border-brand">
                <div class="flex items-center border border-gray-300 rounded-lg">
                     <button data-filter="all" class="veg-filter-btn px-3 py-2 text-sm font-medium rounded-l-lg transition bg-gray-200 text-gray-800">All</button>
                    <button data-filter="veg" class="veg-filter-btn px-3 py-2 text-sm font-medium transition border-l border-gray-300 bg-white">
                        <svg class="w-5 h-5 text-green-600 pointer-events-none" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="4"/></svg>
                    </button>
                    <button data-filter="non-veg" class="veg-filter-btn px-3 py-2 text-sm font-medium rounded-r-lg transition border-l border-gray-300 bg-white">
                        <svg class="w-5 h-5 text-red-600 pointer-events-none" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="4"/></svg>
                    </button>
                </div>
            </div>
            
            <div id="category-navigation-container">
                <h2 id="craving-title" class="text-xl font-bold text-gray-800 mb-4">What are you craving for?</h2>
                <div id="category-grid" class="grid grid-cols-4 gap-4 mb-6"></div>
                <div id="category-tabs" class="overflow-x-auto no-scrollbar whitespace-nowrap mb-4 border-b hidden"></div>
            </div>
        </div>

        <!-- Menu List -->
        <main id="menu-list" class="px-4 pb-48 space-y-4">
            <!-- Menu items appear here -->
        </main>

        <!-- Floating Cart Button -->
        <div id="cart-fab" class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-sm border-t hidden">
            <button id="view-cart-btn" class="bg-brand text-white max-w-lg mx-auto h-14 rounded-xl shadow-lg flex items-center justify-between px-4 hover:bg-brand-dark transition text-lg font-bold">
                <span id="cart-item-count-text" class="text-sm font-semibold"></span>
                <span>View Cart</span>
                <span id="cart-total-preview" class="font-semibold"></span>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
         <div id="table-selection-modal" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center transform transition-all scale-0 hidden">
             <h2 class="text-4xl font-bold mb-6">Select Your Table to Checkout</h2>
             <div id="table-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
        <div id="occupied-table-modal" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all scale-0 hidden">
            <h2 class="text-3xl font-bold mb-2 text-yellow-600">Warning: Table Occupied</h2>
            <p class="text-gray-600 mb-6 text-lg">This table already has an active order. You can continue to place a new, separate order.</p>
            <div class="flex flex-col gap-4">
                <button id="start-new-order-anyway-btn" class="w-full bg-brand text-white text-xl font-bold py-4 rounded-lg hover:bg-brand-dark transition">Continue Separate Order</button>
            </div>
        </div>
        <div id="cart-modal" class="bg-gray-50 rounded-xl shadow-2xl w-full max-w-md transform transition-all scale-0 hidden flex-col">
             <div class="p-6 border-b"><h2 class="text-4xl font-bold text-center">Your Order</h2></div>
             <div id="cart-items" class="p-6 flex-grow overflow-y-auto max-h-[50vh]"></div>
             <div class="p-6 bg-white border-t rounded-b-xl">
                <div class="flex justify-between items-center font-bold text-3xl mb-4">
                    <span>Total:</span>
                    <span id="cart-total">₹0</span>
                </div>
                <div id="checkout-form" class="hidden">
                    <input type="tel" id="whatsapp-number" class="w-full p-4 border rounded-md mb-3 text-xl" placeholder="WhatsApp Number" maxlength="10">
                    <input type="text" id="customer-name" class="w-full p-4 border rounded-md mb-3 hidden text-xl" placeholder="Your Name">
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="confirm-order" class="h-5 w-5 text-brand border-gray-300 rounded ring-brand">
                        <label for="confirm-order" class="ml-3 block text-base text-gray-800">I confirm this is a genuine order.</label>
                    </div>
                </div>
                <button id="checkout-btn" class="w-full bg-gray-800 text-white text-xl font-bold py-4 rounded-lg hover:bg-gray-900 transition">Proceed to Checkout</button>
                 <button id="place-order-btn" class="w-full bg-brand text-white text-xl font-bold py-4 rounded-lg hover:bg-brand-dark transition hidden">Place Order</button>
             </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, addDoc, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
            authDomain: "palette-orders.firebaseapp.com",
            projectId: "palette-orders",
            storageBucket: "palette-orders.firebasestorage.app",
            messagingSenderId: "424044050877",
            appId: "1:424044050877:web:9ea875314de19b70173ad4",
            measurementId: "G-XNVCLD42Y4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let cart = {}, menuItems = {}, orderType = 'Dine-in', selectedTableId = null;
        let isCategorySelected = false;

        const modalContainer = document.getElementById('modal-container');
        const cartModal = document.getElementById('cart-modal');
        const tableSelectionModal = document.getElementById('table-selection-modal');
        const occupiedTableModal = document.getElementById('occupied-table-modal');
        const categoryGrid = document.getElementById('category-grid');
        const categoryTabs = document.getElementById('category-tabs');
        const cravingTitle = document.getElementById('craving-title');
        
        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        
        const levenshteinDistance = (s1, s2) => {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            const costs = new Array(s2.length + 1);
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        };

        function showModal(modal) {
            modalContainer.classList.remove('hidden');
            [tableSelectionModal, cartModal, occupiedTableModal].forEach(m => m.classList.add('hidden', 'scale-0'));
            modal.classList.remove('hidden', 'scale-0');
        }
        function closeAllModals() {
            modalContainer.classList.add('hidden');
        }

        async function fetchMenu() {
            onSnapshot(collection(db, 'menu'), (snapshot) => {
                const categories = new Map();
                menuItems = {};
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    menuItems[item.id] = item;
                    if (item.category && !categories.has(item.category)) {
                        categories.set(item.category, item.imageUrl);
                    }
                });
                renderCategories(categories);
                applyFilters();
            });
        }

        function renderCategories(categoriesMap) {
            let gridHtml = `<div class="text-center category-selector" data-category="All"><div class="w-20 h-20 rounded-full mx-auto bg-gray-200 flex items-center justify-center mb-1 overflow-hidden transition-all duration-200"><img src="https://placehold.co/100x100/a43c1a/ffffff?text=All" class="rounded-full"></div><p class="font-semibold text-sm">All</p></div>`;
            categoriesMap.forEach((img, cat) => {
                gridHtml += `<div class="text-center category-selector" data-category="${cat}"><div class="w-20 h-20 rounded-full mx-auto bg-gray-200 flex items-center justify-center mb-1 overflow-hidden transition-all duration-200"><img src="${img || 'https://placehold.co/100x100'}" class="w-full h-full object-cover"></div><p class="font-semibold text-sm">${cat}</p></div>`;
            });
            categoryGrid.innerHTML = gridHtml;

            let tabsHtml = `<button data-category="All" class="category-tab px-4 py-2 text-gray-500 font-semibold">All</button>`;
            Array.from(categoriesMap.keys()).sort().forEach(cat => {
                tabsHtml += `<button data-category="${cat}" class="category-tab px-4 py-2 text-gray-500 font-semibold">${cat}</button>`;
            });
            categoryTabs.innerHTML = tabsHtml;

            categoryGrid.querySelectorAll('.category-selector').forEach(el => el.addEventListener('click', handleInitialCategorySelection));
            categoryTabs.querySelectorAll('.category-tab').forEach(el => el.addEventListener('click', (e) => {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('category-tab-active'));
                e.currentTarget.classList.add('category-tab-active');
                applyFilters();
            }));
        }

        function handleInitialCategorySelection(e) {
            const selectedCategory = e.currentTarget.dataset.category;
            cravingTitle.classList.add('hidden');
            categoryGrid.classList.add('hidden');
            categoryTabs.classList.remove('hidden');
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('category-tab-active', tab.dataset.category === selectedCategory);
            });
            isCategorySelected = true;
            applyFilters();
        }
        
        function renderMenuItems(items) {
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';
            
            const stockPriority = { 'few_left': 1, 'in_stock': 2, 'sold_out': 3 };
            items.sort((a, b) => (stockPriority[a.stockStatus || 'in_stock'] || 99) - (stockPriority[b.stockStatus || 'in_stock'] || 99));

            items.forEach(item => {
                const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                const card = document.createElement('div');
                card.className = 'menu-item-card bg-white rounded-lg flex items-start gap-3 p-3 relative border-b';
                
                const quantityInCart = cart[item.id] || 0;
                
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center gap-1">
                             <div class="h-4 w-4 rounded-sm ${item.vegStatus === 'non-veg' ? 'border-red-600' : 'border-green-600'} border flex items-center justify-center">
                                <div class="h-2 w-2 rounded-full ${item.vegStatus === 'non-veg' ? 'bg-red-600' : 'bg-green-600'}"></div>
                            </div>
                            <h3 class="font-bold text-base text-gray-800">${item.name}</h3>
                        </div>
                         <p class="text-sm text-gray-600 mt-1">₹${finalPrice.toFixed(0)}</p>
                         ${item.stockStatus === 'few_left' ? '<p class="text-xs text-yellow-600 font-bold">Hurry, only a few left!</p>' : ''}
                         <p class="text-xs text-gray-500 mt-2">${item.description || ''}</p>
                    </div>
                    <div class="w-28 h-28 flex-shrink-0 relative">
                        <img class="w-full h-full object-cover rounded-md" src="${item.imageUrl || `https://placehold.co/100x100/a43c1a/ffffff?text=${encodeURIComponent(item.name)}`}" alt="${item.name}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/a43c1a/ffffff?text=${encodeURIComponent(item.name)}';">
                        <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-20">
                             ${ item.stockStatus === 'sold_out' ? `<div class="text-red-600 bg-red-100 font-bold px-4 py-1 rounded-lg text-sm shadow-md">SOLD OUT</div>` :
                                (quantityInCart > 0 ?
                                    `<div class="flex items-center justify-center bg-brand text-white font-bold rounded-lg text-sm shadow-md h-8">
                                        <button data-id="${item.id}" data-action="decrease" class="cart-modify-btn w-1/3 h-full">-</button>
                                        <span class="w-1/3 text-center">${quantityInCart}</span>
                                        <button data-id="${item.id}" data-action="increase" class="cart-modify-btn w-1/3 h-full">+</button>
                                    </div>` :
                                    `<button data-id="${item.id}" class="add-to-cart-btn bg-white text-brand border border-gray-300 font-bold px-4 py-1 rounded-lg text-sm shadow-md w-full h-8">ADD</button>`
                                )
                            }
                        </div>
                    </div>
                `;
                menuList.appendChild(card);
            });
             document.querySelectorAll('.add-to-cart-btn, .cart-modify-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const { id, action } = e.currentTarget.dataset;
                if(action === 'increase') cart[id] = (cart[id] || 0) + 1;
                else if (action === 'decrease') cart[id]--;
                else cart[id] = 1;

                if (cart[id] <= 0) delete cart[id];
                
                updateCartView();
                applyFilters();
             }));
        }
        
        function applyFilters() {
            const activeVegFilterEl = document.querySelector('.veg-filter-btn.veg-filter-active, .veg-filter-btn.nonveg-filter-active, .veg-filter-btn.bg-gray-200');
            const activeVegFilter = activeVegFilterEl ? activeVegFilterEl.dataset.filter : 'all';
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            
            let filteredItems = Object.values(menuItems);

            if (searchTerm.length > 0) {
                if (!isCategorySelected) {
                    cravingTitle.classList.add('hidden');
                    categoryGrid.classList.add('hidden');
                    categoryTabs.classList.remove('hidden');
                    isCategorySelected = true;
                }
                filteredItems = filteredItems.filter(item => {
                    const name = item.name.toLowerCase();
                    const distance = levenshteinDistance(searchTerm, name);
                    return name.includes(searchTerm) || distance <= 2;
                });
            } else if (!isCategorySelected) {
                document.getElementById('menu-list').innerHTML = '';
                return;
            }

            const activeCategoryEl = document.querySelector('.category-tab-active');
            if(activeCategoryEl && activeCategoryEl.dataset.category !== 'All') {
                 filteredItems = filteredItems.filter(item => item.category === activeCategoryEl.dataset.category);
            }
            
            if (activeVegFilter !== 'all') {
                filteredItems = filteredItems.filter(item => (item.vegStatus || 'veg') === activeVegFilter);
            }
            
            renderMenuItems(filteredItems);
        }
        
        document.getElementById('search-bar').addEventListener('input', applyFilters);
        document.querySelectorAll('.veg-filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.veg-filter-btn').forEach(b => {
                b.classList.remove('veg-filter-active', 'nonveg-filter-active', 'bg-gray-200', 'text-gray-800');
                b.classList.add('bg-white');
            });
            if (e.currentTarget.dataset.filter === 'veg') e.currentTarget.classList.add('veg-filter-active');
            else if (e.currentTarget.dataset.filter === 'non-veg') e.currentTarget.classList.add('nonveg-filter-active');
            else e.currentTarget.classList.add('bg-gray-200', 'text-gray-800');
            applyFilters();
        }));
        
        document.querySelectorAll('.order-type-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(e.currentTarget.disabled) return;
                document.querySelectorAll('.order-type-btn').forEach(b => b.classList.remove('tab-active'));
                e.currentTarget.classList.add('tab-active');
                orderType = e.currentTarget.dataset.type;
                selectedTableId = null; // Reset table selection when changing order type
            });
        });

        function updateCartView() {
            const cartFab = document.getElementById('cart-fab');
            const cartItemCountText = document.getElementById('cart-item-count-text');
            const cartTotalPreview = document.getElementById('cart-total-preview');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            let totalItems = 0, totalPrice = 0;
            for (const itemId in cart) {
                if(!menuItems[itemId]) continue;
                totalItems += cart[itemId];
                const item = menuItems[itemId];
                const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                totalPrice += finalPrice * cart[itemId];
            }
            if (totalItems > 0) {
                cartFab.classList.remove('hidden');
                cartItemCountText.textContent = `${totalItems} item${totalItems > 1 ? 's' : ''}`;
                cartTotalPreview.textContent = `₹${totalPrice.toFixed(0)}`;
            } else {
                cartFab.classList.add('hidden');
            }
            cartItemsContainer.innerHTML = '';
            if (Object.keys(cart).length === 0) {
                 cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 py-8 text-lg">Your cart is empty.</p>';
            } else {
                for (const itemId in cart) {
                    const quantity = cart[itemId];
                    if (quantity > 0 && menuItems[itemId]) {
                        const item = menuItems[itemId];
                        const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center py-4 border-b text-lg';
                        itemEl.innerHTML = `<div><p class="font-semibold">${item.name}</p><p class="text-base text-gray-600">₹${finalPrice.toFixed(0)}</p></div><div class="flex items-center gap-4"><button data-id="${itemId}" data-action="decrease" class="cart-quantity-btn h-8 w-8 bg-gray-200 rounded-full text-xl font-bold">-</button><span class="font-semibold w-4 text-center">${quantity}</span><button data-id="${itemId}" data-action="increase" class="cart-quantity-btn h-8 w-8 bg-gray-200 rounded-full text-xl font-bold">+</button></div>`;
                        cartItemsContainer.appendChild(itemEl);
                    }
                }
            }
            cartTotalEl.textContent = `₹${totalPrice.toFixed(2)}`;
            document.querySelectorAll('.cart-quantity-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const { id, action } = e.currentTarget.dataset;
                 if (action === 'increase') cart[id]++;
                 else if (action === 'decrease') cart[id]--;
                 if (cart[id] <= 0) delete cart[id];
                updateCartView();
                applyFilters();
            }));
        }
        
        document.getElementById('view-cart-btn').addEventListener('click', () => { showModal(cartModal); resetCheckout(); });
        modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) closeAllModals(); });
        
        const checkoutBtn = document.getElementById('checkout-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const whatsappInput = document.getElementById('whatsapp-number');
        
        function resetCheckout() {
            document.getElementById('checkout-form').classList.add('hidden');
            checkoutBtn.classList.remove('hidden');
            placeOrderBtn.classList.add('hidden');
        }

        checkoutBtn.addEventListener('click', () => {
            if (Object.keys(cart).length === 0) return;
            
            if (orderType === 'Dine-in' && !selectedTableId) {
                showModal(tableSelectionModal);
                listenForTableUpdates(true); // Checkout flow
                return;
            }

            document.getElementById('checkout-form').classList.remove('hidden');
            checkoutBtn.classList.add('hidden');
            placeOrderBtn.classList.remove('hidden');
            const savedNumber = localStorage.getItem('customerWhatsapp');
            if (savedNumber) { whatsappInput.value = savedNumber; whatsappInput.dispatchEvent(new Event('blur')); }
        });
        
        placeOrderBtn.addEventListener('click', async () => {
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim();
            const customerName = document.getElementById('customer-name').value.trim();
            const isConfirmed = document.getElementById('confirm-order').checked;
            if (whatsappNumber.length !== 10 || (document.getElementById('customer-name').offsetParent !== null && !customerName) || !isConfirmed || Object.keys(cart).length === 0) { alert('Please fill all details correctly.'); return; }
            
            placeOrderBtn.disabled = true; placeOrderBtn.textContent = 'Placing Order...';
            try {
                localStorage.setItem('customerWhatsapp', whatsappNumber);
                let totalAmount = 0, orderItems = {};
                for (const itemId in cart) {
                    const item = menuItems[itemId];
                    const quantity = cart[itemId];
                    const finalPrice = item.price - (item.price * (item.discount || 0) / 100);
                    totalAmount += finalPrice * quantity;
                    orderItems[itemId] = { name: item.name, quantity: quantity, price: finalPrice };
                }
                const orderData = { customerName, whatsappNumber, items: JSON.stringify(orderItems), totalAmount, status: 'Pending', paymentStatus: 'Unpaid', orderType, tableId: selectedTableId, createdAt: serverTimestamp(), isHidden: false };
                const batch = writeBatch(db);
                batch.set(doc(db, 'customers', whatsappNumber), { name: customerName }, { merge: true });
                const newOrderRef = doc(collection(db, 'orders'));
                batch.set(newOrderRef, orderData);
                if (orderType === 'Dine-in' && selectedTableId) batch.update(doc(db, 'tables', selectedTableId), { status: 'Occupied', orderId: newOrderRef.id });
                await batch.commit();
                alert('Order placed successfully!');
                cart = {}; updateCartView(); closeAllModals();
            } catch (error) { console.error('Error placing order:', error); } 
            finally { placeOrderBtn.disabled = false; placeOrderBtn.textContent = 'Place Order'; }
        });
        
        function listenForTableUpdates(isCheckoutFlow = false) {
            onSnapshot(collection(db, 'tables'), (snapshot) => {
                const tableGrid = document.getElementById('table-grid');
                tableGrid.innerHTML = '';
                const tables = [];
                snapshot.forEach(doc => tables.push(doc.data()));
                tables.sort((a, b) => parseInt(a.tableNumber.slice(1)) - parseInt(b.tableNumber.slice(1)));
                tables.forEach(table => {
                    if (!table.tableNumber) return;
                    const tableEl = document.createElement('button');
                    tableEl.dataset.tableId = table.tableNumber;
                    let bgColor = 'bg-gray-300', textColor = 'text-gray-500', statusText = table.status, isDisabled = (table.status !== 'Available');
                    if(table.status === 'Available') bgColor = 'bg-green-100 hover:bg-green-200';
                    if(table.status === 'Occupied') bgColor = 'bg-yellow-100';
                    tableEl.className = `p-2 rounded-lg text-center transition ${bgColor} ${textColor} disabled:opacity-50`;
                    tableEl.disabled = isDisabled;
                    tableEl.innerHTML = `<div class="font-bold text-lg">${table.tableNumber}</div><div class="text-sm">${statusText}</div>`;
                    tableEl.addEventListener('click', () => {
                        selectedTableId = table.tableNumber;
                        closeAllModals();
                        if (isCheckoutFlow) checkoutBtn.click();
                    });
                    tableGrid.appendChild(tableEl);
                });
            });
        }
        
        window.onload = () => {
            const tableFromURL = window.location.hash.substring(1).toUpperCase();
            if (tableFromURL.startsWith('T')) {
                selectedTableId = tableFromURL;
                document.querySelectorAll('.order-type-btn').forEach(b => b.classList.remove('tab-active'));
                document.querySelector('.order-type-btn[data-type="Dine-in"]').classList.add('tab-active');
            }
            fetchMenu();
        };
        
    </script>
</body>
</html>

